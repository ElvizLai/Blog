<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[1024coder]]></title>
  <link href="1024coder.com/atom.xml" rel="self"/>
  <link href="1024coder.com/"/>
  <updated>2017-08-21T12:34:04+08:00</updated>
  <id>1024coder.com/</id>
  <author>
    <name><![CDATA[]]></name>
  </author>
  <generator uri="http://www.coderforart.com/">CoderForArt</generator>
  
  <entry>
    <title type="html"><![CDATA[Ubuntu å†…æ ¸å‡çº§ + tcp_bbr å¼€å¯]]></title>
    <link href="1024coder.com/15032841145588.html"/>
    <updated>2017-08-21T10:55:14+08:00</updated>
    <id>1024coder.com/15032841145588.html</id>
    <content type="html">
<![CDATA[<p>TCP è¿æ¥ä¸­ï¼Œç”±äºéœ€è¦ç»´æŒè¿æ¥çš„å¯é æ€§ï¼Œå¼•å…¥äº†æ‹¥å¡æ§åˆ¶å’Œæµé‡ç®¡ç†çš„æ–¹æ³•ã€‚Google BBR å°±æ˜¯è°·æ­Œå…¬å¸ï¼ˆéå®˜æ–¹ï¼‰æå‡ºçš„ä¸€å¥—å¼€æº TCP æ‹¥å¡æ§åˆ¶çš„ç®—æ³•ã€‚åœ¨æœ€æ–°çš„ linux 4.9 åŠä»¥ä¸Šçš„å†…æ ¸ç‰ˆæœ¬ä¸­å·²è¢«é‡‡ç”¨ã€‚</p>

<span id="more"></span><!-- more -->

<p>ç”±äºå¼€å¯ tcp_bbr éœ€è¦ kernel 4.9+ï¼Œæ‰€ä»¥ï¼Œéœ€è¦å…ˆæŸ¥çœ‹ä¸‹ç³»ç»Ÿçš„å†…æ ¸æ˜¯å¦æ”¯æŒã€‚</p>

<pre><code>uname -r
</code></pre>

<p>1ã€å¦‚æœå†…æ ¸å°äº 4.9ï¼Œé‚£ä¹ˆéœ€è¦å…ˆå‡çº§å†…æ ¸</p>

<pre><code>wget http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.12.8/linux-headers-4.12.8-041208_4.12.8-041208.201708161815_all.deb

wget http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.12.8/linux-headers-4.12.8-041208-generic_4.12.8-041208.201708161815_amd64.deb

wget http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.12.8/linux-image-4.12.8-041208-generic_4.12.8-041208.201708161815_amd64.deb
</code></pre>

<p>1.1ã€å†…æ ¸å®‰è£…ã€æ›´æ–°ç³»ç»Ÿå¼•å¯¼æ–‡ä»¶å¹¶é‡å¯</p>

<pre><code>sudo dpkg -i linux-*.deb
sudo update-grub
sudo reboot
</code></pre>

<p>2.1ã€TCP_BBRç¡®è®¤</p>

<p>æ‰§è¡Œ <code>lsmod | grep bbr</code>ï¼Œå¦‚æœç»“æœä¸­æ²¡æœ‰ tcp_bbr çš„è¯å°±å…ˆæ‰§è¡Œ</p>

<pre><code>modprobe tcp_bbr
echo &quot;tcp_bbr&quot; &gt;&gt; /etc/modules-load.d/modules.conf
</code></pre>

<p>æ‰§è¡Œ</p>

<pre><code>echo &quot;net.core.default_qdisc=fq&quot; &gt;&gt; /etc/sysctl.conf
echo &quot;net.ipv4.tcp_congestion_control=bbr&quot; &gt;&gt; /etc/sysctl.conf
</code></pre>

<p>ä¿å­˜ç”Ÿæ•ˆ</p>

<pre><code>sysctl -p
</code></pre>

<p>æ‰§è¡Œ</p>

<pre><code>sysctl net.ipv4.tcp_available_congestion_control
sysctl net.ipv4.tcp_congestion_control
</code></pre>

<p>å¦‚æœç»“æœéƒ½æœ‰ bbr, åˆ™è¯æ˜ä½ çš„å†…æ ¸å·²å¼€å¯ bbr</p>

<p>çœ‹åˆ°æœ‰ tcp_bbr æ¨¡å—å³è¯´æ˜bbrå·²å¯åŠ¨</p>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[golang client certç›¸å…³]]></title>
    <link href="1024coder.com/14884282048242.html"/>
    <updated>2017-03-02T12:16:44+08:00</updated>
    <id>1024coder.com/14884282048242.html</id>
    <content type="html">
<![CDATA[<p>å°è¯•æ„å»ºå¾®ä¿¡æ”¯ä»˜ç›¸å…³çš„æ¨¡å—ï¼ŒæŒ‰ç…§å¾®ä¿¡çš„å®‰å…¨è¦æ±‚ï¼Œéœ€è¦ä½¿ç”¨æŒ‡å®šè¯ä¹¦è¿›è¡Œ https é€šä¿¡ï¼Œè®°å½•ä¸‹é‡åˆ°çš„é—®é¢˜åŠå®‰å…¨æ–¹é¢ç›¸å…³çš„äº‹å®œã€‚</p>

<span id="more"></span><!-- more -->

<p>æŒ‰ç…§å¾®ä¿¡çš„æ–‡æ¡£ï¼Œä»–æä¾›äº†4ä»½æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ï¼š*.p12, *_cert.pem, *_key.pem, *ca.pem</p>

<p>å…¶ä¸­ *ca.pem ç”¨äºç¯å¢ƒä¸å…·å¤‡ <code>ca-certificates</code> æ—¶æ‰‹åŠ¨åŠ è½½è¯ä¹¦æ—¶ä½¿ç”¨ã€‚æ¯”å¦‚çº¯å‡€çš„alpineä¸‹ã€‚è¿™ç§æƒ…å†µä¸€èˆ¬ docker è¾ƒå¸¸è§ï¼Œä½†ç°åœ¨ç¬¬ä¸‰æ–¹æ¥å£åŸºæœ¬å·²ç» https åŒ–ï¼Œæ„å»ºdockeræ—¶ä¼šæ·»åŠ ca libã€‚</p>

<p>ä¸å¤šè¯´ï¼Œä¸Šä»£ç ã€‚</p>

<pre><code class="language-golang">var client *http.Client

func init() {
    fb, err := ioutil.ReadFile(&quot;apiclient_cert.p12&quot;)
    if err != nil {
        panic(err)
    }

    b, err := pkcs12.ToPEM(fb, &quot;mchId&quot;) // the password is mchId
    if err != nil {
        panic(err)
    }

    if len(b) != 2 {
        panic(errors.New(&quot;check p12, len not match&quot;))
    }

    cert, err := tls.X509KeyPair(pem.EncodeToMemory(b[0]), pem.EncodeToMemory(b[1]))
    if err != nil {
        panic(err)
    }

    // Load client cert using pem is not safe.
    //cert, err := tls.LoadX509KeyPair(&quot;apiclient_cert.pem&quot;, &quot;apiclient_key.pem&quot;)
    //if err != nil {
    //  panic(err)
    //}

    // Load CA cert
    caCert, err := ioutil.ReadFile(&quot;rootca.pem&quot;)
    if err != nil {
        panic(err)
    }

    caCertPool := x509.NewCertPool()
    caCertPool.AppendCertsFromPEM(caCert)

    // Setup HTTPS client
    tlsConfig := &amp;tls.Config{
        Certificates: []tls.Certificate{cert},
        RootCAs:      caCertPool,
    }
    tlsConfig.BuildNameToCertificate()
    transport := &amp;http.Transport{TLSClientConfig: tlsConfig}

    client = &amp;http.Client{Transport: transport}
}
</code></pre>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[postgres over ç”¨æ³•]]></title>
    <link href="1024coder.com/14845365865254.html"/>
    <updated>2017-01-16T11:16:26+08:00</updated>
    <id>1024coder.com/14845365865254.html</id>
    <content type="html">
<![CDATA[<p>æ€»ç»“ä¸‹ postgres ä¸­ over çš„ç”¨æ³•ã€‚</p>

<span id="more"></span><!-- more -->

<pre><code>func() OVER( [PRITITION BY col1] ORDER BY col2 [DESC ] )
</code></pre>

<p>å¸¸ç”¨çª—å£å‡½æ•°æ±‡æ€»ï¼š</p>

<pre><code>row_number(): ä»å½“å‰å¼€å§‹ï¼Œä¸é—´æ–­,å¦‚1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ï¼Œ6
rank() :ä»å½“å‰å¼€å§‹ï¼Œä¼šé—´æ–­ï¼Œå¦‚1ï¼Œ2ï¼Œ2ï¼Œ4ï¼Œ5ï¼Œ6
dense_rank():ä»å½“å‰å¼€å§‹ä¸é—´æ–­ï¼Œä½†ä¼šé‡å¤ï¼Œå¦‚1ï¼Œ2ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5
percent_rank()ï¼šä»å½“å‰å¼€å§‹ï¼Œè®¡ç®—åœ¨åˆ†ç»„ä¸­çš„æ¯”ä¾‹ï¼Œå¦‚0ï¼Œ0.25ï¼Œ0.25ï¼Œ0.75ï¼Œ1ï¼Œ0ï¼Œ1 ä»0-1ä¸æ–­åœ°å¾ªç¯
cume_dist()ï¼šå½“å‰è¡Œçš„æ’åºé™¤ä»¥åˆ†ç»„çš„æ•°é‡,å¦‚åˆ†ç»„æœ‰4è¡Œï¼Œåˆ™å€¼ä¸º0.25ï¼Œ0.5ï¼Œ0.75ï¼Œ1
ntile(num_buckets integer)ï¼šä»1åˆ°å½“å‰å€¼ï¼Œé™¤ä»¥åˆ†ç»„çš„çš„æ•°é‡ï¼Œå°½å¯èƒ½ä½¿åˆ†å¸ƒå¹³å‡
lag(value any [, offset integer [, default any ]])ï¼šåç§»é‡å‡½æ•°ï¼Œå–æ»åå€¼,å¦‚lag(column_name,2,0)è¡¨ç¤ºå­—æ®µåç§»é‡ä¸º2ï¼Œæ²¡æœ‰åˆ™ç”¨defaultå€¼ä»£æ›¿ï¼Œè¿™é‡Œæ˜¯0ï¼Œä¸å†™é»˜è®¤æ˜¯null
lead(value any [, offset integer [, default any ]])ï¼šåç§»é‡å‡½æ•°ï¼Œå–æå‰å€¼,ç±»ä¸Š
first_value(value any)ï¼šè¿”å›çª—å£æ¡†æ¶ä¸­çš„ç¬¬ä¸€ä¸ªå€¼
last_value(value any)ï¼šè¿”å›çª—å£æ¡†æ¶ä¸­çš„æœ€åä¸€ä¸ªå€¼
nth_value(value any, nth integer)ï¼šè¿”å›çª—å£æ¡†æ¶ä¸­çš„æŒ‡å®šå€¼ï¼Œå¦‚nth_value(salary,2),åˆ™è¡¨ç¤ºè¿”å›å­—æ®µsalaryçš„ç¬¬äºŒä¸ªçª—å£å‡½æ•°å€¼
</code></pre>

<!-- more -->

<p>å‡è®¾æœ‰å¦‚ä¸‹çš„æ•°æ®è¡¨ï¼š</p>

<table>
<thead>
<tr>
<th>depname</th>
<th>empno</th>
<th>salary</th>
<th>enroll_date</th>
</tr>
</thead>

<tbody>
<tr>
<td>develop</td>
<td>10</td>
<td>5200</td>
<td>2007-08-01</td>
</tr>
<tr>
<td>sales</td>
<td>1</td>
<td>5000</td>
<td>2006-10-01</td>
</tr>
<tr>
<td>personnel</td>
<td>5</td>
<td>3500</td>
<td>2007-12-10</td>
</tr>
<tr>
<td>sales</td>
<td>4</td>
<td>4800</td>
<td>2007-08-08</td>
</tr>
<tr>
<td>sales</td>
<td>6</td>
<td>5500</td>
<td>2007-01-02</td>
</tr>
<tr>
<td>personnel</td>
<td>2</td>
<td>3900</td>
<td>2006-12-23</td>
</tr>
<tr>
<td>develop</td>
<td>7</td>
<td>4200</td>
<td>2008-01-01</td>
</tr>
<tr>
<td>develop</td>
<td>9</td>
<td>4500</td>
<td>2008-01-01</td>
</tr>
<tr>
<td>sales</td>
<td>3</td>
<td>4800</td>
<td>2007-08-01</td>
</tr>
<tr>
<td>develop</td>
<td>8</td>
<td>6000</td>
<td>2006-10-01</td>
</tr>
<tr>
<td>develop</td>
<td>11</td>
<td>5200</td>
<td>2007-08-15</td>
</tr>
</tbody>
</table>

<p>a. ç»Ÿè®¡å„éƒ¨é—¨çš„æ€»è–ªæ°´ï¼Œå¹³å‡è–ªæ°´å’Œéƒ¨é—¨çš„è¯¦ç»†æƒ…å†µ</p>

<pre><code>select sum(salary) OVER (PARTITION BY depname),avg(salary) OVER (PARTITION BY depname),* from empsalary;
  sum  |          avg          |  depname  | empno | salary | enroll_date 
-------+-----------------------+-----------+-------+--------+-------------
 25100 | 5020.0000000000000000 | develop   |    10 |   5200 | 2007-08-01
 25100 | 5020.0000000000000000 | develop   |     7 |   4200 | 2008-01-01
 25100 | 5020.0000000000000000 | develop   |     9 |   4500 | 2008-01-01
 25100 | 5020.0000000000000000 | develop   |     8 |   6000 | 2006-10-01
 25100 | 5020.0000000000000000 | develop   |    11 |   5200 | 2007-08-15
  7400 | 3700.0000000000000000 | personnel |     2 |   3900 | 2006-12-23
  7400 | 3700.0000000000000000 | personnel |     5 |   3500 | 2007-12-10
 20100 | 5025.0000000000000000 | sales     |     3 |   4800 | 2007-08-01
 20100 | 5025.0000000000000000 | sales     |     1 |   5000 | 2006-10-01
 20100 | 5025.0000000000000000 | sales     |     4 |   4800 | 2007-08-08
 20100 | 5025.0000000000000000 | sales     |     6 |   5500 | 2007-01-02
(11 rows)
</code></pre>

<p>b.ç»Ÿè®¡äººå‘˜åœ¨æ‰€åœ¨éƒ¨é—¨çš„è–ªæ°´æ’åæƒ…å†µ</p>

<pre><code>select rank() OVER (PARTITION BY depname ORDER BY salary),* from empsalary;
 rank |  depname  | empno | salary | enroll_date 
------+-----------+-------+--------+-------------
    1 | develop   |     7 |   4200 | 2008-01-01
    2 | develop   |     9 |   4500 | 2008-01-01
    3 | develop   |    10 |   5200 | 2007-08-01
    3 | develop   |    11 |   5200 | 2007-08-15
    5 | develop   |     8 |   6000 | 2006-10-01
    1 | personnel |     5 |   3500 | 2007-12-10
    2 | personnel |     2 |   3900 | 2006-12-23
    1 | sales     |     4 |   4800 | 2007-08-08
    1 | sales     |     3 |   4800 | 2007-08-01
    3 | sales     |     1 |   5000 | 2006-10-01
    4 | sales     |     6 |   5500 | 2007-01-02
(11 rows)
</code></pre>

<p>TODO</p>

<hr/>

<p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://my.oschina.net/Kenyon/blog/79543">https://my.oschina.net/Kenyon/blog/79543</a></p>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dockerå¿«é€Ÿç¿»è¶ŠGFWæœ­è®°]]></title>
    <link href="1024coder.com/14766094528973.html"/>
    <updated>2016-10-16T17:17:32+08:00</updated>
    <id>1024coder.com/14766094528973.html</id>
    <content type="html">
<![CDATA[<p>è®°å½•äº†PPTPã€L2TPã€Shadowsocksã€IKEv2å€ŸåŠ©dockerçš„ç¿»è¶Šæ–¹å¼ã€‚</p>

<span id="more"></span><!-- more -->

<h2 id="toc_0">1.PPTP</h2>

<pre><code>docker run -d --privileged --net=host \
                -v {/path_to_file/chap-secrets}:/etc/ppp/chap-secrets \
                sdrzlyz/pptp
</code></pre>

<p>PPTP ä½¿ç”¨ /etc/ppp/chap-secrets æ–‡ä»¶è®¾ç½®ç”¨æˆ·åå’Œå¯†ç ï¼Œæ‰€ä»¥ä½ éœ€è¦ç»™dockerå®¹å™¨æä¾›è¿™ä¸ªæ–‡ä»¶ï¼Œä¸‹é¢æ˜¯è¿™ä¸ªæ–‡ä»¶çš„ç¤ºä¾‹ï¼š</p>

<pre><code># Secrets for authentication using PAP
# client    server      secret           acceptable local IP addresses
username   *           password    *
</code></pre>

<h2 id="toc_1">2.L2TP/IPSec</h2>

<pre><code>docker run -d -p 500:500/udp -p 4500:4500/udp -p 1701:1701/tcp \
               -e PSK={å…±äº«å¯†ç } -e USERNAME={ç”¨æˆ·å}-e PASSWORD={å¯†ç }\
              siomiz/softethervpn
</code></pre>

<h2 id="toc_2">3.Shadowsocks</h2>

<pre><code>docker run -d -p 465:465  -s 0.0.0.0 -p 465 \
                -k {å¯†ç } -m aes-256-cfb \
                oddrationale/docker-shadowsocks
</code></pre>

<h2 id="toc_3">4.IKEv2</h2>

<pre><code>docker run -d --privileged \
                --name ikev2-vpn-server \
                --restart=always -p 500:500/udp -p 4500:4500/udp \
                gaomd/ikev2-vpn-server:0.3.0
</code></pre>

<p>è¯ä¹¦å¯¼å‡º(hostä¸­å¯é…ç½®åŸŸåæˆ–è€…ipåœ°å€)ï¼š</p>

<pre><code>docker run --privileged -i -t --rm --volumes-from ikev2-vpn-server -e &quot;HOST=vpn1.example.com&quot; gaomd/ikev2-vpn-server:0.3.0 generate-mobileconfig &gt; ikev2-vpn.mobileconfig
</code></pre>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[HBase golangåˆæ¢]]></title>
    <link href="1024coder.com/14766097423984.html"/>
    <updated>2016-10-16T17:22:22+08:00</updated>
    <id>1024coder.com/14766097423984.html</id>
    <content type="html">
<![CDATA[<p>æœ€è¿‘è¦è¿›è¡Œå¤§æ•°æ®ç›¸å…³çš„ä»»åŠ¡ï¼Œç‰›åˆ€å°è¯•ï¼Œå…ˆå°†æœ€åŸºç¡€çš„HBaseæ­å»ºå¹¶å®è·µèµ·æ¥ã€‚æœ¬æ–‡å€Ÿç”¨dockerï¼Œå¿«é€Ÿæ­å»ºHBaseåŸºç¡€ç¯å¢ƒï¼Œå¹¶ä½¿ç”¨goç»“åˆthriftè°ƒç”¨ç›¸å…³APIè¿›è¡Œæ•°æ®æ“ä½œã€‚</p>

<span id="more"></span><!-- more -->

<p>0ã€æ–¹ä¾¿èµ·è§ï¼Œéœ€è¦ä¸€ä¸ªdockerç¯å¢ƒï¼Œå®‰è£…é…ç½®ç•¥è¿‡ä¸è¡¨ã€‚</p>

<p>1ã€æ‹‰å–image</p>

<pre><code>docker pull harisekhon/hbase
</code></pre>

<p>2ã€ä¿®æ”¹entrypoint.shï¼Œå¯ç”¨thrift2</p>

<pre><code>/hbase/bin/hbase-daemon.sh start thrift2
</code></pre>

<p>3ã€æŒ‚è½½ä¿®æ”¹åçš„å¯åŠ¨æ–‡ä»¶ï¼Œå¯åŠ¨hbaseï¼Œå¹¶æš´éœ²thrift2ç«¯å£</p>

<pre><code>docker run -d -p 9090:9090 -v `pwd`/entrypoint.sh:/entrypoint.sh --name hbase harisekhon/hbase
</code></pre>

<p>4ã€è¿è¡Œhbase shellï¼Œå»ºè¡¨</p>

<pre><code>docker exec -it hbase bash

hbase shell

// å»ºè¡¨
create &#39;elvizlai_test&#39;,{NAME =&gt; &#39;f1&#39;, VERSIONS =&gt; 2},{NAME =&gt; &#39;f2&#39;, VERSIONS =&gt; 2}

// åˆ é™¤è¡¨
disable &#39;elvizlai_test&#39;
drop &#39;elvizlai_test&#39;
</code></pre>

<p>4ã€thrift for macå®‰è£…ï¼Œæ„Ÿè°¢homebrew</p>

<pre><code>brew install thrift
</code></pre>

<p>5ã€ä¸‹è½½hbase thrift2å¯¹åº”çš„hbase.thriftæ–‡ä»¶ï¼Œç”Ÿæˆgo package</p>

<pre><code>wget https://raw.githubusercontent.com/apache/hbase/master/hbase-thrift/src/main/resources/org/apache/hadoop/hbase/thrift2/hbase.thrift
thrift -r -out . --gen go *.thrift
</code></pre>

<p>6ã€æ’°å†™main.goä¸€æ¢ç©¶ç«Ÿå§</p>

<pre><code class="language-go">package main

import (
    &quot;encoding/binary&quot;
    &quot;fmt&quot;
    &quot;hbase&quot;
    &quot;reflect&quot;
    &quot;strconv&quot;
    &quot;time&quot;

    &quot;git.apache.org/thrift.git/lib/go/thrift&quot;
)

const HOST = &quot;127.0.0.1&quot;
const PORT = &quot;9090&quot;
const TESTRECORD = 10

func main() {
    startTime := currentTimeMillis()
    logformatstr_ := &quot;----%s\n&quot;
    logformatstr := &quot;----%s ç”¨æ—¶:%d-%d=%dæ¯«ç§’\n\n&quot;
    logformattitle := &quot;å»ºç«‹è¿æ¥&quot;

    table := &quot;elvizlai_test&quot;
    rowkey := &quot;1&quot;
    family := &quot;f1&quot;

    protocolFactory := thrift.NewTBinaryProtocolFactoryDefault()

    transport, err := thrift.NewTSocket(HOST + &quot;:&quot; + PORT)
    if err != nil {
        panic(err)
    }

    client := hbase.NewTHBaseServiceClientFactory(transport, protocolFactory)

    if err := transport.Open(); err != nil {
        panic(err)
    }
    tmpendTime := currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, startTime, (tmpendTime - startTime))
    defer transport.Close()

    //--------------Exists
    logformattitle = &quot;è°ƒç”¨Existsæ–¹æ³•&quot;
    fmt.Printf(logformatstr_, logformattitle)
    tmpstartTime := currentTimeMillis()
    isexists, err := client.Exists([]byte(table), &amp;hbase.TGet{Row: []byte(rowkey)})
    fmt.Printf(&quot;rowkey{%s} in table{%s} Exists:%t\n&quot;, rowkey, table, isexists)
    tmpendTime = currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, tmpstartTime, (tmpendTime - tmpstartTime))

    //--------------Put
    logformattitle = &quot;è°ƒç”¨Putæ–¹æ³•å†™æ•°æ®&quot;
    fmt.Printf(logformatstr_, logformattitle)
    tmpstartTime = currentTimeMillis()
    cvarr := []*hbase.TColumnValue{
        {
            Family:    []byte(family),
            Qualifier: []byte(&quot;idoall.org&quot;),
            Value:     []byte(&quot;welcome idoall.org&quot;),
        },
    }
    temptput := hbase.TPut{Row: []byte(rowkey), ColumnValues: cvarr}
    err = client.Put([]byte(table), &amp;temptput)
    if err != nil {
        fmt.Printf(&quot;Put err:%s\n&quot;, err)
    } else {
        fmt.Println(&quot;Put done&quot;)
    }
    tmpendTime = currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, tmpstartTime, (tmpendTime - tmpstartTime))

    //------------Get---------------
    logformattitle = &quot;è°ƒç”¨Getæ–¹æ³•è·å–æ–°å¢åŠ çš„æ•°æ®&quot;
    fmt.Printf(logformatstr_, logformattitle)
    tmpstartTime = currentTimeMillis()

    result, err := client.Get([]byte(table), &amp;hbase.TGet{Row: []byte(rowkey)})
    if err != nil {
        fmt.Printf(&quot;Get err:%s\n&quot;, err)
    } else {
        fmt.Println(&quot;Rowkey:&quot; + string(result.Row))
        for _, cv := range result.ColumnValues {
            printscruct(cv)
        }
    }
    tmpendTime = currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, tmpstartTime, (tmpendTime - tmpstartTime))

    //--------------put update
    logformattitle = &quot;è°ƒç”¨Put updateæ–¹æ³•&#39;ä¿®æ”¹&#39;æ•°æ®&quot;
    fmt.Printf(logformatstr_, logformattitle)
    tmpstartTime = currentTimeMillis()
    cvarr = []*hbase.TColumnValue{
        {
            Family:    []byte(family),
            Qualifier: []byte(&quot;idoall.org&quot;),
            Value:     []byte(&quot;welcome idoall.org---update&quot;),
        },
    }
    temptput = hbase.TPut{Row: []byte(rowkey), ColumnValues: cvarr}
    err = client.Put([]byte(table), &amp;temptput)
    if err != nil {
        fmt.Printf(&quot;Put update err:%s\n&quot;, err)
    } else {
        fmt.Println(&quot;Put update done&quot;)
    }
    tmpendTime = currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, tmpstartTime, (tmpendTime - tmpstartTime))

    //------------Get  update---------------
    logformattitle = &quot;è°ƒç”¨Getæ–¹æ³•è·å–&#39;ä¿®æ”¹&#39;åçš„æ•°æ®&quot;
    fmt.Printf(logformatstr_, logformattitle)
    tmpstartTime = currentTimeMillis()
    //
    result, err = (client.Get([]byte(table), &amp;hbase.TGet{Row: []byte(rowkey)}))
    if err != nil {
        fmt.Printf(&quot;Get update err:%s\n&quot;, err)
    } else {
        fmt.Println(&quot;update Rowkey:&quot; + string(result.Row))
        for _, cv := range result.ColumnValues {
            printscruct(cv)
        }
    }
    tmpendTime = currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, tmpstartTime, (tmpendTime - tmpstartTime))

    //------------DeleteSingle------------
    logformattitle = &quot;è°ƒç”¨DeleteSingleæ–¹æ³•åˆ é™¤ä¸€æ¡æ•°æ®&quot;
    fmt.Printf(logformatstr_, logformattitle)
    tmpstartTime = currentTimeMillis()
    tdelete := hbase.TDelete{Row: []byte(rowkey)}
    err = client.DeleteSingle([]byte(table), &amp;tdelete)
    if err != nil {
        fmt.Printf(&quot;DeleteSingle err:%s\n&quot;, err)
    } else {
        fmt.Print(&quot;DeleteSingel done\n&quot;)
    }

    tmpendTime = currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, tmpstartTime, (tmpendTime - tmpstartTime))

    //-------------PutMultiple----------------
    logformattitle = &quot;è°ƒç”¨PutMultipleæ–¹æ³•æ·»åŠ &quot; + strconv.Itoa(TESTRECORD) + &quot;æ¡æ•°æ®&quot;
    fmt.Printf(logformatstr_, logformattitle)
    tmpstartTime = currentTimeMillis()

    var tputArr []*hbase.TPut
    for i := 0; i &lt; TESTRECORD; i++ {
        putrowkey := strconv.Itoa(i)

        tputArr = append(tputArr, &amp;hbase.TPut{
            Row: []byte(putrowkey),
            ColumnValues: []*hbase.TColumnValue{
                {
                    Family:    []byte(family),
                    Qualifier: []byte(&quot;idoall.org&quot;),
                    Value:     []byte(time.Now().String()),
                },
            }})
    }

    err = client.PutMultiple([]byte(table), tputArr)
    if err != nil {
        fmt.Printf(&quot;PutMultiple err:%s\n&quot;, err)
    } else {
        fmt.Print(&quot;PutMultiple done\n&quot;)
    }

    tmpendTime = currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, tmpstartTime, (tmpendTime - tmpstartTime))

    //------------------GetMultiple-----------------------------
    logformattitle = &quot;è°ƒç”¨GetMultipleæ–¹æ³•è·å–&quot; + strconv.Itoa(TESTRECORD) + &quot;æ•°æ®&quot;
    fmt.Printf(logformatstr_, logformattitle)
    tmpstartTime = currentTimeMillis()
    //
    var tgets []*hbase.TGet
    for i := 0; i &lt; TESTRECORD; i++ {
        putrowkey := strconv.Itoa(i)
        tgets = append(tgets, &amp;hbase.TGet{
            Row: []byte(putrowkey)})
    }
    results, err := client.GetMultiple([]byte(table), tgets)
    if err != nil {
        fmt.Printf(&quot;GetMultiple err:%s&quot;, err)
    } else {
        fmt.Printf(&quot;GetMultiple Count:%d\n&quot;, len(results))
        for _, k := range results {
            fmt.Println(&quot;Rowkey:&quot; + string(k.Row))
            for _, cv := range k.ColumnValues {
                printscruct(cv)
            }
        }
    }
    tmpendTime = currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, tmpstartTime, (tmpendTime - tmpstartTime))
    //-------------------TMutation
    //TMutationåŒ…å«ä¸€ä¸ªTGetä¸€ä¸ªTPutï¼Œå°±ä¸åšæµ‹è¯•äº†
    //å¯ä»¥å’ŒMutateRowç»“åˆä½¿ç”¨
    //

    //-------------------OpenScanner
    logformattitle = &quot;è°ƒç”¨OpenScanneræ–¹æ³•&quot;
    fmt.Printf(logformatstr_, logformattitle)
    tmpstartTime = currentTimeMillis()
    startrow := make([]byte, 4)
    binary.LittleEndian.PutUint32(startrow, 1)
    stoprow := make([]byte, 4)
    binary.LittleEndian.PutUint32(stoprow, 10)

    scanresultnum, err := client.OpenScanner([]byte(table), &amp;hbase.TScan{
        StartRow: startrow,
        StopRow:  stoprow,
        //     FilterString: []byte(&quot;RowFilter(=, &#39;regexstring:00[1-3]00&#39;)&quot;),
        //     FilterString: []byte(&quot;PrefixFilter(&#39;1407658495588-&#39;)&quot;),
        Columns: []*hbase.TColumn{
            {
                Family:    []byte(family),
                Qualifier: []byte(&quot;idoall.org&quot;),
            },
        },
    })
    if err != nil {
        fmt.Printf(&quot;OpenScanner err:%s\n&quot;, err)
    } else {
        fmt.Printf(&quot;OpenScanner %d done\n&quot;, scanresultnum)
        scanresult, err := client.GetScannerRows(scanresultnum, 100)
        if err != nil {
            fmt.Printf(&quot;GetScannerRows err:%s\n&quot;, err)
        } else {
            fmt.Printf(&quot;GetScannerRows %d done\n&quot;, len(scanresult))
            for _, k := range scanresult {
                fmt.Println(&quot;scan Rowkey:&quot; + string(k.Row))
                for _, cv := range k.ColumnValues {
                    printscruct(cv)
                }
            }
        }
    }
    tmpendTime = currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, tmpstartTime, (tmpendTime - tmpstartTime))

    //--closescanner
    logformattitle = &quot;è°ƒç”¨CloseScanneræ–¹æ³•&quot;
    fmt.Printf(logformatstr_, logformattitle)
    tmpstartTime = currentTimeMillis()
    err = client.CloseScanner(scanresultnum)
    if err != nil {
        fmt.Printf(&quot;CloseScanner err:%s\n&quot;, err)
    }
    tmpendTime = currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, tmpstartTime, (tmpendTime - tmpstartTime))

    //-------------------GetScannerResults
    logformattitle = &quot;è°ƒç”¨GetScannerResultsæ–¹æ³•&quot;
    fmt.Printf(logformatstr_, logformattitle)
    tmpstartTime = currentTimeMillis() //
    gsr, err := client.GetScannerResults([]byte(table), &amp;hbase.TScan{
        StartRow: startrow,
        StopRow:  stoprow,
        //     FilterString: []byte(&quot;RowFilter(=, &#39;regexstring:00[1-3]00&#39;)&quot;),
        //     FilterString: []byte(&quot;PrefixFilter(&#39;1407658495588-&#39;)&quot;),
        Columns: []*hbase.TColumn{
            {
                Family:    []byte(family),
                Qualifier: []byte(&quot;idoall.org&quot;),
            },
        }}, 100)
    if err != nil {
        fmt.Printf(&quot;GetScannerResults err:%s\n&quot;, err)
    } else {
        fmt.Printf(&quot;GetScannerResults %d done\n&quot;, len(gsr))
        for _, k := range gsr {
            fmt.Println(&quot;scan Rowkey:&quot; + string(k.Row))
            for _, cv := range k.ColumnValues {
                printscruct(cv)
            }
        }
    }

    tmpendTime = currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, tmpstartTime, (tmpendTime - tmpstartTime))

    //---------------DeleteMultiple--------------
    logformattitle = &quot;è°ƒç”¨DeleteMultipleæ–¹æ³•åˆ é™¤&quot; + strconv.Itoa(TESTRECORD) + &quot;æ•°æ®&quot;
    fmt.Printf(logformatstr_, logformattitle)
    tmpstartTime = currentTimeMillis()
    var tdelArr []*hbase.TDelete
    for i := 0; i &lt; TESTRECORD; i++ {
        putrowkey := strconv.Itoa(i)
        tdelArr = append(tdelArr, &amp;hbase.TDelete{
            Row: []byte(putrowkey)})
    }
    r, err := client.DeleteMultiple([]byte(table), tdelArr)
    if err != nil {
        fmt.Printf(&quot;DeleteMultiple err:%s\n&quot;, err)
    } else {
        fmt.Printf(&quot;DeleteMultiple %d done\n&quot;, TESTRECORD)
        fmt.Println(r)
    }
    tmpendTime = currentTimeMillis()
    fmt.Printf(logformatstr, logformattitle, tmpendTime, tmpstartTime, (tmpendTime - tmpstartTime))

    endTime := currentTimeMillis()
    fmt.Printf(&quot;\nGolangè°ƒç”¨æ€»è®¡ç”¨æ—¶:%d-%d=%dæ¯«ç§’\n&quot;, endTime, startTime, (endTime - startTime))

}

func currentTimeMillis() int64 {
    return time.Now().UnixNano() / 1000000
}

func printscruct(cv interface{}) {
    switch reflect.ValueOf(cv).Interface().(type) {
    case *hbase.TColumnValue:
        s := reflect.ValueOf(cv).Elem()
        typeOfT := s.Type()
        //è·å–Thrift2ä¸­structçš„field
        for i := 0; i &lt; s.NumField(); i++ {
            f := s.Field(i)
            fileldformatstr := &quot;\t%d: %s(%s)= %v\n&quot;
            switch f.Interface().(type) {
            case []uint8:
                fmt.Printf(fileldformatstr, i, typeOfT.Field(i).Name, f.Type(), string(f.Interface().([]uint8)))
            case *int64:
                var tempint64 int64
                if f.Interface().(*int64) == nil {
                    tempint64 = 0
                } else {
                    tempint64 = *f.Interface().(*int64)
                }
                fmt.Printf(fileldformatstr, i, typeOfT.Field(i).Name, f.Type(), tempint64)
            default:
                fmt.Print(&quot;I don&#39;t know&quot;)
            }
        }
    default:
        fmt.Print(&quot;I don&#39;t know&quot;)
        fmt.Print(reflect.ValueOf(cv))
    }

}
</code></pre>

<hr/>

<blockquote>
<p>Step6ä¸­çš„ä»£ç æ‘˜è‡ª <code>http://www.cnblogs.com/lion.net/p/3928453.html</code></p>
</blockquote>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åŸºäºgrpcçš„å¾®æœåŠ¡å®è·µ]]></title>
    <link href="1024coder.com/14766109567964.html"/>
    <updated>2016-10-16T17:42:36+08:00</updated>
    <id>1024coder.com/14766109567964.html</id>
    <content type="html">
<![CDATA[<h2 id="toc_0">ç®€ä»‹</h2>

<p>è¿‘ä¸€ä¸¤å¹´æ¥ï¼Œå¾®æœåŠ¡æ¶æ„å·²ç»æˆä¸ºçƒ­é—¨è¯é¢˜ï¼ˆ<a href="http://microservices.io/index.html">microservices.io</a>)ï¼Œä¸ä¼ ç»Ÿçš„ä¸€ä½“åŒ–åº”ç”¨æ¶æ„ç›¸æ¯”ï¼Œå¾®æœåŠ¡æ¶æ„åœ¨å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²æ–¹é¢éƒ½æœ‰ä¼—å¤šå¸å¼•äººä¹‹å¤„ï¼Œè¶Šæ¥è¶Šå¤šæ²¡æœ‰å†å²åŒ…è¢±çš„æ–°é¡¹ç›®éƒ½å¯ç”¨å¾®æœåŠ¡æ¶æ„çš„æ¨¡å¼æ¥å¼€å‘ã€‚</p>

<p>æˆ‘ä»¬è¿™ä¸ªå›¢é˜Ÿç»è¿‡æ·±å…¥æ€è€ƒä¹‹åï¼Œå†³å®šåœ¨ä¸€èµ·ç¾è¿™ä¸ªAPPçš„åç«¯å¼€å‘ä¸­ï¼Œé€‰æ‹©<a href="http://www.golang.org">go</a>ä½œä¸ºå¼€å‘è¯­è¨€ï¼Œé‡‡ç”¨å¾®æœåŠ¡æ¨¡å¼æ¥å®ç°ï¼Œç»è¿‡è¿‘åŠå¹´çš„å®è·µï¼Œå½¢æˆäº†ä¸€äº›å¿ƒå¾—ï¼Œç®€å•æ€»ç»“ååˆ†äº«å‡ºæ¥ï¼Œå¸Œæœ›èƒ½å¤Ÿç»™å¤§å®¶ä¸€äº›å¸®åŠ©ã€‚</p>

<span id="more"></span><!-- more -->

<h2 id="toc_1">æ¡†æ¶é€‰æ‹©</h2>

<p>ä¸åŒçš„å›¢é˜Ÿåœ¨é€‰æ‹©åŸºç¡€æ¡†æ¶ï¼ˆåº“ï¼‰æ—¶è€ƒè™‘çš„è¦ç´ ä¸åŒï¼Œæˆ‘ä»¬å›¢é˜Ÿæ›´å–œæ¬¢å°è€Œç¾çš„æ¡†æ¶ï¼Œå°½å¯èƒ½ä¸è¦è®©æ¡†æ¶ä¾µå…¥ä¸šåŠ¡ï¼Œæ˜“äºå‡çº§ã€ç»´æŠ¤å’Œæ›¿æ¢ï¼Œæ‰€ä»¥æˆ‘ä»¬æ›´æ„¿æ„é€‰æ‹©Libraryè€Œä¸æ˜¯Frameworkã€‚</p>

<p>åœ¨webæ–¹é¢ï¼Œæˆ‘ä»¬é€‰æ‹©äº†<a href="https://github.com/urfave/negroni">negroni</a>ä½œä¸ºmiddlewareåº“ï¼Œé‡‡ç”¨æ€§èƒ½ä¸é”™çš„<a href="https://github.com/julienschmidt/httprouter">httprouter</a>æ›¿æ¢goæ ‡å‡†åº“çš„muxï¼Œè€Œæ²¡æœ‰ç”¨ä»»ä½•webç›¸å…³çš„æ¡†æ¶ã€‚</p>

<p>åœ¨å¾®æœåŠ¡ä¹‹é—´çš„rpcè°ƒç”¨æ–¹é¢ï¼Œä¸ºäº†å°†æ¥çš„æ‰©å±•æ€§ã€è·¨è¯­è¨€è°ƒç”¨ç­‰å› ç´ ï¼Œæˆ‘ä»¬æ²¡æœ‰ç›´æ¥ç”¨goæ ‡å‡†åº“çš„rpcæ¨¡å—ï¼Œè€Œæ˜¯é‡‡çº³äº†googleæœ€æ–°æ¨å‡ºçš„grpcã€‚ä½†grpcæœ¬èº«å±äºæ¯”è¾ƒé‡å‹çš„rpcæ¡†æ¶ï¼Œå¯¹ä¸šåŠ¡ä»£ç æœ‰ä¸€å®šçš„ä¾µå…¥æ€§ï¼Œæˆ‘ä»¬åšäº†ä¸€ç³»åˆ—çš„åº“ï¼ˆåŒ…æ‹¬<a href="https://gihthub.com/wothing/worpc">worpc</a>ã€<a href="https://github.com/wothing/worc">worc</a>ã€<a href="https://github.com/wothing/wonaming">wonaming</a>ç­‰ï¼‰æ¥å±è”½è¿™äº›ä¸å¿…è¦çš„ä¸šåŠ¡ä»£ç ä¾µå…¥ï¼Œä¿æŒäº†ä¸šåŠ¡ä»£ç æœ¬èº«çš„æ•´æ´ã€‚</p>

<h2 id="toc_2">å¾®æœåŠ¡åˆ’åˆ†</h2>

<p>åœ¨å¾®æœåŠ¡ä½“ç³»ä¸­ï¼Œå¦‚ä½•åˆ‡åˆ†å¾®æœåŠ¡ä¹Ÿæ˜¯ä¸€ä¸ªé‡è¦çš„è¯é¢˜ï¼Œåœ¨æˆ‘ä»¬çš„å®è·µä¸­ï¼Œæˆ‘ä»¬éµå¾ªäº†å¦‚ä¸‹ä¸€äº›åŸåˆ™ï¼š<br/>
1. é€»è¾‘ç‹¬ç«‹ã€è¾¹ç•Œæ¸…æ™°çš„æ¨¡å—ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡<br/>
2. æ¯ä¸ªtableåªç”±ä¸€ä¸ªå¾®æœåŠ¡æ“ä½œï¼ˆåŒ…æ‹¬æ’å…¥ã€è¯»å–ã€æ›´æ”¹ã€åˆ é™¤ç­‰ï¼‰<br/>
3. tableä¹‹é—´ä¸å¼•å…¥å¤–é”®çº¦æŸï¼Œidå­—æ®µå…¨éƒ¨é‡‡ç”¨uuid<br/>
4. å°†éœ€è¦ä¿æŒæ•°æ®ä¸€è‡´æ€§çš„æ“ä½œæ”¾åœ¨ä¸€ä¸ªå¾®æœåŠ¡ä¸­ï¼Œé¿å…è·¨æœåŠ¡å¸¦æ¥çš„æ•°æ®ä¸€è‡´æ€§éš¾é¢˜<br/>
5. å¾®æœåŠ¡ä¹‹é—´çš„é€šä¿¡ï¼Œå°½å¯èƒ½é‡‡ç”¨æ¶ˆæ¯é˜Ÿåˆ—å®ç°æ¾è€¦åˆï¼Œå½“éœ€è¦åŒæ­¥è°ƒç”¨æ—¶å†å€ŸåŠ©äºrpc<br/>
6. å¾®æœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼Œé€šè¿‡etcdå®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°</p>

<h2 id="toc_3">æ€»ä½“æ¶æ„</h2>

<p><img src="http://blog-1024coder.qiniudn.com/%E6%9E%B6%E6%9E%84.png!DesktopWS" alt="æ¶æ„"/></p>

<h2 id="toc_4">Gateway</h2>

<p>Gatewayæ˜¯å¾®æœåŠ¡å¯¹å¤–æä¾›æœåŠ¡çš„ä¸€ä¸ªå±éšœï¼Œå®ƒçš„æ ¸å¿ƒç‚¹åœ¨äºï¼š<br/>
1. å±è”½å¾®æœåŠ¡ä¹‹é—´é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ã€rpcç­‰é€šä¿¡æ–¹å¼ï¼Œä¸ºWebé¡µé¢å’Œç§»åŠ¨APPæä¾›åŸºäºHTTPåè®®çš„RESTful APIæ¥å£<br/>
2. å¯¹æ¯ä¸€ä¸ªhttpä¸šåŠ¡è¯·æ±‚è¿›è¡Œå¿…è¦çš„é‰´æƒå’Œæ•°æ®å®Œæ•´æ€§ã€åˆæ³•æ€§æ£€æŸ¥ï¼Œä»¥å‡å°‘å¾®æœåŠ¡çš„è´Ÿæ‹…ï¼Œè®©å¾®æœåŠ¡çš„ä»£ç æ›´çº¯ç²¹<br/>
3. å¾®æœåŠ¡éƒ¨ç½²ä½“ç³»ä¸­ï¼Œæ¯ä¸ªå¾®æœåŠ¡å¯èƒ½ä¼šéƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼ŒGatewayè¿˜æ‰¿æ‹…ç€åœ¨è¿™äº›å®ä¾‹ä¸­è¿›è¡Œè´Ÿè½½å‡è¡¡çš„åŠŸèƒ½<br/>
4. è¿›è¡Œå¿…è¦çš„æ—¥å¿—è¾“å‡ºã€ç›‘æ§æ‰“ç‚¹ç­‰åŠŸèƒ½ï¼Œå¯¹æ¯ä¸€ä¸ªæ¥è‡ªäºAPPå’Œé¡µé¢çš„httpè¯·æ±‚ï¼Œç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„trace idï¼Œå¹¶å°†trace idä¼ å¯¼åˆ°æ¯ä¸€ä¸ªåç»­çš„å¾®æœåŠ¡ä¸­ï¼Œä»¥ä¾¿åç»­çš„æŸ¥é”™å’Œæ€§èƒ½è°ƒä¼˜<br/>
5. Gatewayçš„æ¯ä¸€ä¸ªhttpè¯·æ±‚éƒ½æ˜¯æ— çŠ¶æ€çš„ï¼Œé‡‡ç”¨JWTï¼ˆJson Web Tokenï¼‰æœºåˆ¶å®ç°ä¸€ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚çŠ¶æ€ä¿¡æ¯çš„ä¼ é€’</p>

<h2 id="toc_5">æœåŠ¡çš„æ³¨å†Œä¸å‘ç°<a href="https://github.com/wothing/wonaming">wonaming</a></h2>

<p>å¾®æœåŠ¡ä½“ç³»ä¸­ï¼ŒæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°å¯¹æ•´ä½“æ¶æ„éå¸¸é‡è¦ï¼Œå°¤å…¶å¯¹äºåŒæ­¥çš„rpcè°ƒç”¨ï¼Œæ¯ä¸ªæœåŠ¡æœ‰å¤šå°‘å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹çš„åœ°å€ç­‰ï¼Œéƒ½éœ€è¦æœ‰ä¸€ä¸ªç»Ÿä¸€çš„ç®¡ç†ã€‚æˆ‘ä»¬é‡‡ç”¨etcdä¿å­˜æœåŠ¡ä¿¡æ¯ï¼ŒåŒæ—¶å°è£…äº†wonamingä½œä¸ºå¾®æœåŠ¡æ³¨å†Œå’Œå‘ç°çš„ä¸­é—´ä»¶ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š<br/>
1. æœåŠ¡åœ¨å¯åŠ¨æ—¶ï¼Œè°ƒç”¨wonamingå‘etcdæ³¨å†ŒåŒ…å«TTLçš„æœåŠ¡â€œç´¢å¼•â€ã€<br/>
2. æ³¨å†Œåï¼ŒæœåŠ¡ä¸etcdä¿æŒå®šæ—¶å¿ƒè·³ï¼Œå½“å¾®æœåŠ¡ä¸»åŠ¨é€€å‡ºæˆ–è¶…æ—¶ï¼ŒæœåŠ¡è§£æ³¨å†Œå¹¶â€œä¸‹çº¿â€<br/>
3. åœ¨Gatewayä¸­ï¼Œé€šè¿‡resolverè¿›è¡ŒæœåŠ¡å‘ç°ï¼Œé…åˆgrpcæä¾›çš„balancerå®ç°è´Ÿè½½å‡è¡¡ï¼Œresolverå¯åŠ¨åä¼šå¯¹etcdä¸­çš„ <code>/wonaming</code> ç›®å½•è¿›è¡Œç›‘æ§ï¼Œå½“æœ‰æœåŠ¡æ³¨å†Œæˆ–è€…è§£æ³¨å†Œæ—¶ï¼ŒåŠ¨æ€ç»´æŠ¤å¯ç”¨æœåŠ¡æ¸…å•ã€‚</p>

<pre><code class="language-go">r := wonaming.NewResolver(name)
b := grpc.RoundRobin(r)
conn, err := grpc.Dial(etcd, grpc.WithInsecure(), grpc.WithBalancer(b))
</code></pre>

<h2 id="toc_6">æœåŠ¡çš„rpcè°ƒç”¨<a href="https://github.com/wothing/worc">worc</a></h2>

<p>grpcæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡çš„rpcæ¡†æ¶ï¼Œå½“å®¢æˆ·ç«¯é€šè¿‡grpcè°ƒç”¨æœåŠ¡ç«¯æ—¶ï¼Œéœ€è¦å¤§é‡çš„é‡å¤æ€§ä»£ç æ¥å»ºç«‹è¿æ¥ã€è°ƒç”¨ã€å¤„ç†é”™è¯¯è¿”å›ç­‰ï¼Œå½±å“ä¸šåŠ¡ä»£ç çš„æ•´æ´æ€§ï¼Œå¹¶ä¸”å¯¹ä¸šåŠ¡ä»£ç å…·æœ‰å¾ˆå¼ºçš„ä¾µå…¥æ€§ï¼Œä¸ºäº†è§„é¿è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°è£…äº†worcï¼Œä»¥å®ç°ä¾¿æ·çš„grpcè°ƒç”¨ï¼š</p>

<pre><code class="language-go">resp, err := worc.CallRPC(ctx, &quot;hello&quot;, &quot;Hello&quot;, req)
</code></pre>

<h2 id="toc_7">grpcçš„ä¸­é—´ä»¶é“¾<a href="https://github.com/wothing/worpc">worpc</a></h2>

<p>grpcæä¾›äº†interceptoræœºåˆ¶ï¼Œä½†å¹¶æ²¡æœ‰æä¾›chainæ¥å®ç°ä¸åŒçš„ä¸­é—´ä»¶çš„é¡ºåºæ‰§è¡Œï¼Œä¸ºäº†å°†ä¸åŒçš„ä¸­é—´ä»¶åŠŸèƒ½ï¼ˆå¦‚é‰´æƒã€æ—¥å¿—ã€recoverï¼‰å°è£…åœ¨ä¸åŒçš„å‡½æ•°é‡Œï¼Œworpcæä¾›äº†ç»„åˆgprc interceptorä¸ºä¸€ä¸ªchainçš„èƒ½åŠ›ï¼Œå¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡çš„éœ€è¦ï¼Œæ’°å†™ä¸åŒçš„grpcä¸­é—´ä»¶è¿›è¡Œç»„åˆï¼Œæ¯”å¦‚å®ç° grpc çš„ recovery ä¸ log ä¸­é—´ä»¶ï¼š</p>

<pre><code class="language-go">func Recovery(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (resp interface{}, err error) {
    defer func() {
        if r := recover(); r != nil {
            // log stack
            stack := make([]byte, MAXSTACKSIZE)
            stack = stack[:runtime.Stack(stack, false)]
            log.CtxErrorf(ctx, &quot;panic grpc invoke: %s, err=%v, stack:\n%s&quot;, info.FullMethod, r, string(stack))
            // if panic, set custom error to &#39;err&#39;, in order that client and sense it.
            err = grpc.Errorf(codes.Internal, &quot;panic error: %v&quot;, r)
        }
    }()
    return handler(ctx, req)
}

func Logging(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (resp interface{}, err error) {
    start := time.Now()

    log.CtxInfof(ctx, &quot;calling %s, req=%s&quot;, info.FullMethod, marshal(req))
    resp, err = handler(ctx, req)
    log.CtxInfof(ctx, &quot;finished %s, took=%v, resp=%v, err=%v&quot;, info.FullMethod, time.Since(start), marshal(resp), err)

    return resp, err
}
</code></pre>

<pre><code class="language-go">s := grpc.NewServer(grpc.UnaryInterceptor(worpc.UnaryInterceptorChain(worpc.Recovery, worpc.Logging)))
</code></pre>

<p>é€šè¿‡ä»¥ä¸Šç»„åˆï¼Œå¯ä¸ºå¾®æœåŠ¡æä¾›panicæ¢å¤èƒ½åŠ›ï¼Œä¿éšœæœåŠ¡ç¨³å®šå¯ç”¨ï¼›åŒæ—¶è¿˜å°†ä¸Šæ–‡ä¸­æåˆ°çš„æ³¨å…¥contextä¸­çš„trace idå–å‡ºï¼Œè¿™æ ·Gatewayä¸å¾®æœåŠ¡çš„æ—¥å¿—é€šè¿‡å°±è¡”æ¥äº†èµ·æ¥ï¼Œæ–¹ä¾¿æŸ¥é”™ã€è°ƒä¼˜ç­‰ã€‚</p>

<h2 id="toc_8">å…¶å®ƒç»éªŒ</h2>

<ol>
<li>ä½¿ç”¨<code>grpc.Errorf</code>å°è£…ä¸šåŠ¡ä¸­çš„é€»è¾‘é”™è¯¯ï¼ŒéšgrpcæœåŠ¡è°ƒç”¨ä¸€èµ·è¿”å›ï¼Œå°†ä¸šåŠ¡responseä¸error åˆ†ç¦»ã€‚</li>
<li>æ•°æ®å¯åœ¨Gatewayä¸­å®Œæˆç»„è£…å·¥ä½œï¼Œä½†æ— éœ€åˆ»æ„é¿å…å¾®æœåŠ¡äº’è°ƒï¼Œç†æ¸…ä¾èµ–å…³ç³»ï¼Œå°¤å…¶å½“protobufå‡çº§æ—¶ï¼Œæ ¹æ®å…·ä½“ä¸šåŠ¡æ¥åˆ¤æ–­å¼•ç”¨å¾®æœåŠ¡æ˜¯å¦éœ€è¦åŒæ­¥é‡éƒ¨ç½²ã€‚</li>
<li>å¾®æœåŠ¡è™½å¥½ï¼Œä½†ä¸€å®šç¨‹åº¦ä¸Šä¼šåŠ å¤§å®æ–½éš¾åº¦ï¼Œè¦æ ¹æ®ä¸šåŠ¡ä½“é‡åˆç†å…¥å‘ã€‚</li>
</ol>

<h2 id="toc_9">æ€»ç»“</h2>

<p>ä»¥ä¸Šæ˜¯å¾®æœåŠ¡æ¶æ„åœ¨æˆ‘ä»¬å›¢é˜Ÿçš„å®è·µæ–¹æ¡ˆï¼Œéº»é›€è™½å°ï¼Œäº”è„ä¿±å…¨ã€‚é€šè¿‡å„ä¸­é—´ä»¶çš„çµæ´»ç»„åˆï¼Œä¿éšœä¸šåŠ¡æœ‰åºä¸æœåŠ¡çš„é«˜å¯ç”¨ï¼Œè¿˜ä¸æŠ“ç´§å®è·µèµ·æ¥ï¼Ÿåœ¨åç»­çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šä»‹ç»ç›®å‰å¾®æœåŠ¡æµ‹è¯•ã€è¿ç»´åŠéƒ¨ç½²æ–¹æ¡ˆã€‚</p>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[postgresä¸»ä»é…ç½®]]></title>
    <link href="1024coder.com/14766110748248.html"/>
    <updated>2016-10-16T17:44:34+08:00</updated>
    <id>1024coder.com/14766110748248.html</id>
    <content type="html">
<![CDATA[<h4 id="toc_0">å¥½ä¹…æ²¡æœ‰å†™æ–‡ç« äº†ï¼Œç”±äºç”Ÿäº§éœ€è¦ï¼Œå°†postgresçš„ä¸»ä»é…ç½®ç ”ä¹ äº†ä¸€éã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œä½¿ç”¨dockeræ¥ç®€åŒ–æ“ä½œã€‚ç‰©ç†æœºä¸Šçš„æ“ä½œç±»åŒã€‚</h4>

<span id="more"></span><!-- more -->

<p>1ã€ åˆ›å»ºä¸¤ä¸ªpostgresçš„containerï¼Œä¸€ä¸ªåšä¸»ï¼Œä¸€ä¸ªåšä»ã€‚</p>

<pre><code>docker run -d -v /data1:/data -e PGDATA=/data -e POSTGRES_PASSWORD=PASSWORD1 --name db_master postgres postgres
docker run -d -v /data2:/data -e PGDATA=/data -e POSTGRES_PASSWORD=PASSWORD2 --name db_slave postgres postgres
</code></pre>

<p>2ã€ åœ¨masterèŠ‚ç‚¹åˆ›å»ºreplç”¨æˆ·</p>

<pre><code>docker exec -it db_master psql -U postgres -c &quot;CREATE USER rep REPLICATION LOGIN CONNECTION LIMIT 1 ENCRYPTED PASSWORD &#39;PASSWORD_FOR_REP&#39;;&quot;
</code></pre>

<p>3ã€ ä¿®æ”¹masteræ•°æ®åº“çš„é…ç½®ã€‚<code>/data1/pg_hba.conf</code></p>

<pre><code>host    replication     rep     IP_address_of_slave/32   md5
</code></pre>

<p>4ã€ ä¿®æ”¹masteræ•°æ®åº“çš„é…ç½®ã€‚<code>/data1/postgresql.conf</code></p>

<pre><code>listen_addresses = &#39;*&#39;
wal_level = &#39;hot_standby&#39;
archive_mode = on
archive_command = &#39;cd .&#39;
max_wal_senders = 1
hot_standby = on
</code></pre>

<p>5ã€ é‡å¯æ•°æ®åº“å¤‡ç”¨</p>

<pre><code>docker restart db_master
</code></pre>

<p>6ã€ å…ˆåœæ‰ä»èŠ‚ç‚¹slave</p>

<pre><code>docker stop db_slave
</code></pre>

<p>7ã€ ä¿®æ”¹slaveé…ç½®ã€‚<code>/data2/pg_hba.conf</code></p>

<pre><code>host    replication     rep     IP_address_of_master/32  md5
</code></pre>

<p>8ã€ ä¿®æ”¹slaveé…ç½®ã€‚<code>/data2/postgresql.conf</code></p>

<pre><code>listen_addresses = &#39;*&#39;
wal_level = &#39;hot_standby&#39;
archive_mode = on
archive_command = &#39;cd .&#39;
max_wal_senders = 1
hot_standby = on
</code></pre>

<p>9ã€ ä¸»æ•°æ®åº“åˆå§‹åŒ–</p>

<pre><code>    # è¿›å…¥å¤‡ä»½çŠ¶æ€
    docker exec -it db_master psql -U postgres -c &quot;select pg_start_backup(&#39;initial_backup&#39;);&quot;

    rsync -cva --inplace /data1/ /data2/

    # rsync -cva --inplace /data1/ slave_IP_address:/data2/

    # é€€å‡ºå¤‡ä»½çŠ¶æ€
    docker exec -it db_master psql -U postgres -c &quot;select pg_stop_backup();&quot;
</code></pre>

<p>10ã€ ä»æ•°æ®åº“slaveæ¢å¤ç­–ç•¥<code>/data2/recovery.conf</code></p>

<pre><code>standby_mode = &#39;on&#39;
primary_conninfo = &#39;host=master_IP_address port=5432 user=rep password=yourpassword&#39;
trigger_file = &#39;/tmp/postgresql.trigger.5432&#39;
</code></pre>

<p>11ã€ ä»æ•°æ®åº“å¯åŠ¨</p>

<pre><code>docker start db_slave
</code></pre>

<p>æ³¨æ„ï¼šç¬¬10æ­¥ä½œç”¨æ˜¯å½“masteræŒ‚æ‰åï¼Œå¯ä»¥è®©slaveå˜èº«masterï¼Œä¸”å˜çš„å¯å†™ã€‚ä½†ç¬¬10æ­¥çš„é£é™©æ˜¯å¯èƒ½å¯¼è‡´masteråŒæ­¥å¤±è´¥ï¼Œæ¯”è¾ƒç¨³å¦¥çš„åšæ³•æ˜¯ï¼š</p>

<pre><code>1.master å…ˆè¿›å…¥å¤‡ä»½çŠ¶æ€
2.rsyncåŒæ­¥æ•°æ®
3.slave å¯åŠ¨
4.masteré€€å‡ºå¤‡ä»½çŠ¶æ€
</code></pre>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[nsqçš„dockerä¹‹æ—…]]></title>
    <link href="1024coder.com/14766119204994.html"/>
    <updated>2016-10-16T17:58:40+08:00</updated>
    <id>1024coder.com/14766119204994.html</id>
    <content type="html">
<![CDATA[<p>NSQæ˜¯ç”¨goè¯­è¨€å¼€å‘çš„ä¸€æ¬¾æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ¬æ–‡è®°å½•äº†å€ŸåŠ©dockerå¿«é€Ÿæ­å»ºå¼€å‘è¿‡ç¨‹ã€‚</p>

<span id="more"></span><!-- more -->

<p>1.docker networkåˆ›å»º</p>

<p><code>docker network create nsq</code></p>

<p>2.è¿è¡Œdockerå®¹å™¨nsqlookupd</p>

<p><code>docker run -d --net=nsq -p 4160:4160 -p 4161:4161 --name nsqlookupd nsqio/nsq /nsqlookupd</code></p>

<p>3.è¿è¡Œdockerå®¹å™¨nsqd</p>

<p><code>docker run -d --net=nsq -p 4150:4150 -p 4151:4151 --name nsqd nsqio/nsq /nsqd --broadcast-address=192.168.99.111 --lookupd-tcp-address=nsqlookupd:4160</code></p>

<p>å…¶ä¸­ broadcast-address æ˜¯å…¬ç½‘åœ°å€</p>

<p>4.è¿è¡Œdockerå®¹å™¨nsqadmin</p>

<p><code>docker run -d --net=nsq --name nsqadmin -p 4171:4171 nsqio/nsq /nsqadmin  --lookupd-http-address=nsqlookupd:4161</code></p>

<p>ç„¶åå°±å¯ä»¥é€šè¿‡:4171æ¥è®¿é—®nsqadminå•¦</p>

<p>èµ¶ç´§å‘ä¸¤æ¡æ¶ˆæ¯çœ‹çœ‹å§</p>

<pre><code>    curl -d &#39;hello world 1&#39; &#39;http://192.168.99.111:4151/put?topic=test&#39;
    curl -d &#39;hello world 2&#39; &#39;http://192.168.99.111:4151/put?topic=test&#39;
</code></pre>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Macä¸‹ä¸ºæ ‘è“æ´¾3å®‰è£…Ubuntu Mate 16.04]]></title>
    <link href="1024coder.com/14766120910281.html"/>
    <updated>2016-10-16T18:01:31+08:00</updated>
    <id>1024coder.com/14766120910281.html</id>
    <content type="html">
<![CDATA[<p>åº”ç”¨äºæ ‘è“æ´¾3çš„Ubuntu Mate 16.04å‡ºæ¥å•¦ï¼Œèµ¶ç´§æŠŠå®˜æ–¹è‡ªå¸¦çš„raspbianæ¢æ‰å§ğŸ˜Š</p>

<span id="more"></span><!-- more -->

<p>1ã€é¦–å…ˆå»å®˜ç½‘ä¸‹è½½ç”¨äºæ ‘è“æ´¾çš„unbuntué•œåƒã€‚<a href="https://ubuntu-mate.org/raspberry-pi/">https://ubuntu-mate.org/raspberry-pi/</a></p>

<p>2ã€ä½¿ç”¨Macè‡ªå¸¦çš„è§£å‹ç¼©å·¥å…·è§£å‹åç¼€ä¸ºxzçš„æ–‡ä»¶ï¼Œå¾—åˆ°imgæ–‡ä»¶</p>

<p>3ã€ä½¿ç”¨SDFromatterå·¥å…·å°†SDå¡æ ¼å¼åŒ–</p>

<p>4ã€ä½¿ç”¨<code>df -h</code>å‘½ä»¤æŸ¥çœ‹æŒ‚è½½çš„uç›˜å·ï¼Œæœ¬ä¾‹ä¸ºdisk2s1</p>

<p>5ã€å¸è½½è¯¥å·ï¼š<code>sudo diskutil umount /dev/disk2s1</code></p>

<p>6ã€ä½¿ç”¨<code>diskutil list</code>æ¥ç¡®è®¤è®¾å¤‡</p>

<p>7ã€ä½¿ç”¨ddå‘½ä»¤å°†ç³»ç»Ÿé•œåƒå†™å…¥ï¼š</p>

<pre><code>sudo dd bs=4m if=ubuntu-mate-16.04-desktop-armhf-raspberry-pi.img of=/dev/rdisk2
</code></pre>

<p>æ³¨æ„ï¼Œæœ€åçš„æ˜¯rdisk2ï¼Œä¸æ˜¯disk2ï¼Œæ›´ä¸æ˜¯disk2s1ã€‚<br/>
ï¼ˆè¯´æ˜ï¼š/dev/disk2s1æ˜¯åˆ†åŒºï¼Œ/dev/disk2æ˜¯å—è®¾å¤‡ï¼Œ/dev/rdisk2æ˜¯åŸå§‹å­—ç¬¦è®¾å¤‡ï¼‰</p>

<p>8ã€ç»è¿‡æ¼«é•¿çš„ç­‰å¾…ï¼Œåˆ·å…¥å®Œæ¯•ï¼Œ<code>sudo diskutil unmountDisk /dev/disk2</code>å¸è½½è®¾å¤‡ã€‚å°†sdå¡æ’å…¥æ ‘è“æ´¾ï¼Œè¿›è¡Œå¸¸è§„å®‰è£…ã€‚</p>

<p>9ã€å‰©ä½™éƒ¨åˆ†å°±æ˜¯å¯åŠ¨åå°†sdå¡å……åˆ†åˆ©ç”¨äº†ã€‚</p>

<pre><code>sudo fdisk /dev/mmcblk0
æŒ‰på›è½¦ï¼Œåˆ—å‡ºæ‰€æœ‰
æŒ‰då›è½¦ï¼Œé€‰2--åˆ é™¤ç¬¬äºŒä¸ªåˆ†åŒº
æŒ‰nå›è½¦ï¼Œæ–°å»ºåˆ†åŒº
åˆ†åŒºç±»å‹é€‰pï¼Œç„¶åé€‰2ï¼Œç„¶åä¸€è·¯å›è½¦
æœ€åwä¿å­˜

sudo rebooté‡å¯è®¾å¤‡

é‡æ–°ç™»å…¥è®¾å¤‡åï¼šsudo resize2fs /dev/mmcblk0p2
</code></pre>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[go sql ä¹‹ Query]]></title>
    <link href="1024coder.com/14766121755274.html"/>
    <updated>2016-10-16T18:02:55+08:00</updated>
    <id>1024coder.com/14766121755274.html</id>
    <content type="html">
<![CDATA[<p>1ã€ä½¿ç”¨txæ—¶ï¼Œrowsæ²¡æœ‰closeæ˜¯å¦ä¼šå¯¼è‡´æœ‰æœªè¢«é‡Šæ”¾çš„æ•°æ®åº“è¿æ¥ï¼Ÿ<br/>
å½“æœ€åæ‰§è¡Œtx.Commit()æˆ–tx.Rollback()æ—¶ï¼Œç›¸åº”çš„è¿æ¥ä¼šè¢«å…³é—­ã€‚ä¸ä¼šå­˜åœ¨æœªè¢«é‡Šæ”¾çš„æƒ…å†µã€‚ä½†ä»ç„¶å»ºè®®å…»æˆå…³é—­çš„å¥½ä¹ æƒ¯ã€‚</p>

<p>2ã€rows.Err()çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ<br/>
Err()çš„ç›¸å…³æ³¨é‡Šæ˜¯è¿™æ ·å†™çš„ï¼šErr returns the error, if any, that was encountered during iteration.<br/>
ä½†è¯·æ³¨æ„ï¼Œè¿™äº›é”™è¯¯ï¼Œä»…ä¸è¿­ä»£è¿‡ç¨‹ä¸­rowsé”™è¯¯ç›¸å…³ï¼Œæ¯”å¦‚åœ¨ä¸‹ä¸€ä¸ªNext()æ—¶ï¼Œæ•°æ®åº“å‡ºé—®é¢˜äº†ï¼Œæˆ–è€…txå·²ç»ç»“æŸï¼Œtxå‘ç”Ÿé”™è¯¯ã€‚<br/>
ä¸Scan()å¤„äº§ç”Ÿçš„é”™è¯¯æ²¡æœ‰ä»»ä½•å…³è”ã€‚<br/>
æ‰€ä»¥ï¼Œè¿™ä¸¤éƒ¨åˆ†é”™è¯¯åº”è¯¥å•ç‹¬åˆ†åˆ«å¤„ç†ã€‚</p>

<p>3ã€rows.Next()ä¸­è¿›è¡Œtx.Exec(update)æ“ä½œï¼Ÿ<br/>
å¦‚æœrows.Next()æ˜¯ç”±txå‘èµ·çš„ï¼Œupdateè¯­å¥ä¸­åŒ…å«$1è½¬è¯‘ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚æ­¤æ—¶updateç›¸å…³ï¼Œåº”è¯¥æ”¾åˆ°Nextå¾ªç¯ä¹‹å¤–è¿›è¡Œã€‚<br/>
å¦‚æœè¿›è¡Œæ— è½¬ç§»updateï¼Œåˆ™å…è®¸è¯¥æ“ä½œã€‚<br/>
å¦‚æœrows.Next()æ˜¯æœ‰DBå‘èµ·çš„ï¼Œåˆ™ä»¥ä¸Šæ“ä½œéƒ½æ˜¯å…è®¸çš„ã€‚</p>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[goåŸºç¡€æ€»ç»“]â€”â€”bytesåŒ…]]></title>
    <link href="1024coder.com/14766122451393.html"/>
    <updated>2016-10-16T18:04:05+08:00</updated>
    <id>1024coder.com/14766122451393.html</id>
    <content type="html">
<![CDATA[<p>æ€»ç»“ä¸‹bytesåŒ…ä¸­çš„å„æ“ä½œã€‚</p>

<span id="more"></span><!-- more -->

<p>å†™</p>

<pre><code class="language-go">func main() {
    // æ“ä½œç›®æ ‡
    data := make([]byte, 6)

    buff := bytes.NewWriter(data)

    //å¾€ç›®æ ‡ä¸­å†™å…¥1,2,3,ç›®æ ‡å˜ä¸º[1,2,3,0,0,0]
    buff.Write([]byte{1, 2, 3})
    fmt.Println(buff.Bytes())//è¾“å‡ºbuffä¸­å†™å…¥çš„å†…å®¹,åº”è¯¥ä¸º[1,2,3]

    //å¾€ç›®æ ‡ä¸­ç»§ç»­å†™å…¥æ•°æ®,å˜æˆ[1,2,3,4,5,6]
    buff.Write([]byte{4, 5, 6})

    n, err := buff.Write([]byte{7})
    fmt.Println(n, err)//ç”±äºç›®æ ‡å·²ç»æ»¡äº†,ç»§ç»­å†™å°±ä¼šé€ æˆio.EOFé”™è¯¯å•¦,nä¸º0

    //å†™æ¸¸æ ‡é‡ç½®
    buff.Reset()

    //åˆèƒ½æ„‰å¿«çš„å¾€ç›®æ ‡åŒºå†™å†…å®¹å•¦
    buff.Write([]byte{7, 8, 9})
    fmt.Println(buff.Bytes())//æ³¨æ„,é‡ç½®çš„é™¤äº†æ¸¸æ ‡,buffå†…åŸæ¥çš„å†…å®¹ä¹Ÿæ¸…ç©º

    fmt.Println(data)//ä½†æ˜¯æ“ä½œåŒºå¹¶ä¸ä¼šåº”ä¸ºResetè€Œæ¸…ç©º,åº”è¯¥è¾“å‡º[7,8,9,4,5,6]
}
</code></pre>

<p>è¯»</p>

<pre><code class="language-go">func main() {
    // æ“ä½œç›®æ ‡,è¿™ä¸ªä¸€èˆ¬å¯èƒ½ä¼šè¶…çº§å¤§
    data := []byte{1, 2, 3, 4, 5, 6, 7, 8}

    buff := bytes.NewReader(data)

    //è¿™ä¸ªä¸€èˆ¬æ˜¯ç”¨æ¥åšå¤ç”¨çš„ç¼“å†²åŒº,ä¸€èˆ¬å°äºdataçš„é•¿åº¦,ä¸ºäº†è¯•éªŒæ•ˆæœ,å‡è®¾ä¸º4
    x := [4]byte{}
    for {
        n, err := buff.Read(x[:])
        if err != nil&amp;&amp;err == io.EOF {
            break
        }
        fmt.Println(&quot;temp&quot;, x[:n])
    }

    fmt.Println(&quot;remian:&quot;, buff.Bytes())//éƒ½è¢«è¯»å…‰äº†,ç°åœ¨åº”è¯¥æ˜¯ç©ºçš„äº†

    buff.SeekToBegin()//é‡æ–°è½½å…¥ä¸€ä¸‹
    fmt.Println(&quot;remian:&quot;, buff.Bytes())//å¯ä»¥çœ‹åˆ°åˆæ»¡äº†

    fmt.Println(buff.Seek(3,1))
    fmt.Println(&quot;remian:&quot;, buff.Bytes())//ä»å½“å‰ä½ç½®,æ¸¸æ ‡è·³3,å‰©ä½™[4,5,6,7,8]

    fmt.Println(buff.Seek(2,0))
    fmt.Println(&quot;remian:&quot;, buff.Bytes())//ä»èµ·å§‹ä½ç½®,æ¸¸æ ‡è·³2ä¸ª,å‰©ä½™[3,4,5,6,7,8],å¯ä»¥çœ‹åˆ°,éšå«ä¸€ä¸ªé‡ç½®è¿‡ç¨‹

    fmt.Println(buff.Seek(2,1))
    fmt.Println(&quot;remian:&quot;, buff.Bytes())//ä»å½“å‰ä½ç½®,æ¸¸æ ‡è·³2,å‰©ä½™[5,6,7,8]


    fmt.Println(buff.Seek(-3,2))
    fmt.Println(&quot;remian:&quot;, buff.Bytes())//ä»æœ«å°¾å¼€å§‹å¾€å‰æ•°,æ¸¸æ ‡è·³3,å‰©ä½™[6,7,8]
}
</code></pre>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[grpc over tls]]></title>
    <link href="1024coder.com/14766124024042.html"/>
    <updated>2016-10-16T18:06:42+08:00</updated>
    <id>1024coder.com/14766124024042.html</id>
    <content type="html">
<![CDATA[<p>grpcæœ¬èº«å¯ä»¥å·¥ä½œäºå¸¸è§„çš„tcpæ¨¡å¼ï¼Œä½†å‡ºäºæ•°æ®äº¤æ¢çš„ä¿å¯†æ€§åŠå®‰å…¨è§’åº¦è€ƒè™‘ï¼Œåœ¨å…¶ä¸ŠåŠ ä¸€å±‚tlsä¹Ÿæ˜¯æå¥½çš„ã€‚</p>

<span id="more"></span><!-- more -->

<p>Step1ï¼š<br/>
    è¯ä¹¦ç›¸å…³è¯·ç¿»é˜…ä»¥å‰çš„æ–‡ç« ã€‚ä½¿ç”¨ï¼š<br/>
    â€” ç”Ÿæˆ RSA ç§é’¥ï¼ˆä¼ ç»Ÿæ ¼å¼çš„ï¼‰<br/>
    â€” è‡ªç­¾åè¯ä¹¦</p>

<p>Step2ï¼š<br/>
    å»ºä¸€ä¸ªäº¤æ¢ä¸“ç”¨çš„packageå§</p>

<pre><code class="language-go">package key

import (
    &quot;crypto/tls&quot;
    &quot;crypto/x509&quot;
    &quot;log&quot;

    &quot;google.golang.org/grpc/credentials&quot;
)

var certPEMBlock = []byte(`-----BEGIN CERTIFICATE-----
MIIEMDCCAxigAwIBAgIJAO8uVrXywwnLMA0GCSqGSIb3DQEBBQUAMG0xCzAJBgNV
å†…å®¹éšè—ğŸ˜Š
aiJQH2u5zeca9eFkLZzcTUZmgvw=
-----END CERTIFICATE-----
`)

var keyPEMBlock = []byte(`-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEArB4dHJpPxhoLAGMyp3sXgjIHIlUeZBQGM1xlpYq3wb0YtYZl
å†…å®¹éšè—ğŸ˜Š
zXPJfyC/bgm20s7B029Ojmwy3ReoTY2oL2hCeRRiUXp82Az+wCQ=
-----END RSA PRIVATE KEY-----
`)

func ServerTLS() credentials.TransportAuthenticator {
    cert, err := tls.X509KeyPair(certPEMBlock, keyPEMBlock)
    if err != nil {
        log.Fatal(err)
    }

    return credentials.NewTLS(&amp;tls.Config{Certificates: []tls.Certificate{cert}})
}

func ClientTLS() credentials.TransportAuthenticator {
    cp := x509.NewCertPool()
    if !cp.AppendCertsFromPEM(certPEMBlock) {
        log.Fatal(&quot;Credentials: Failed to append certificates&quot;)
    }

    return credentials.NewTLS(&amp;tls.Config{ServerName: &quot;è¯ä¹¦ç­¾åç›¸å…³&quot;, RootCAs: cp})
}
</code></pre>

<p>Step3ï¼š<br/>
    ServeræœåŠ¡ç«¯ï¼š</p>

<pre><code class="language-go">s := grpc.NewServer(grpc.Creds(key.ServerTLS()))
pb.RegisterXXXServiceServer(s, &amp;service.XXXServer{})
s.Serve(lis)
</code></pre>

<p>Step4ï¼š<br/>
    Clientå®¢æˆ·ç«¯ï¼š</p>

<pre><code class="language-go">conn, err := grpc.Dial(address, grpc.WithPerRPCCredentials(key.ClientTLS()))
</code></pre>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[go ç¼–è¯‘æ—¶æ³¨å…¥]]></title>
    <link href="1024coder.com/14766125154205.html"/>
    <updated>2016-10-16T18:08:35+08:00</updated>
    <id>1024coder.com/14766125154205.html</id>
    <content type="html">
<![CDATA[<pre><code class="language-go">package main

import (
    &quot;fmt&quot;
)

var DEBUG = &quot;NO&quot;

func main() {
    fmt.Printf(&quot;DEBUG is %q\n&quot;, DEBUG)
}
</code></pre>

<p>ä½¿ç”¨ldflagsåŠ¨æ€æ³¨å…¥ï¼š</p>

<pre><code>go build -ldflags &#39;-X main.DEBUG=YES&#39; test.go
</code></pre>

<span id="more"></span><!-- more -->

<p>-Xä»…æ”¯æŒstringç±»å‹</p>

<p>æ›´å¤æ‚ä¸€ç‚¹çš„ï¼Œè¿˜æœ‰ä½¿ç”¨tagsæ¥æŒ‡å®šç¼–è¯‘ï¼š<br/>
main.go</p>

<pre><code class="language-go">package main

func main() {
    Debug()
}
</code></pre>

<p>log_prod.go</p>

<pre><code class="language-go">// +build !debug

package main

func Debug() {
}

</code></pre>

<p>log_debug.go</p>

<pre><code class="language-go">// +build debug

package main

import (
    &quot;fmt&quot;
)

func Debug() {
    fmt.Println(&quot;This is Debug info&quot;)
}
</code></pre>

<p>go build -tags debug<br/>
åˆ™ä¼šè¾“å‡ºè°ƒè¯•ä¿¡æ¯</p>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å…¬é’¥ å¯†é’¥ è¯ä¹¦æ•´ç†]]></title>
    <link href="1024coder.com/14766126348503.html"/>
    <updated>2016-10-16T18:10:34+08:00</updated>
    <id>1024coder.com/14766126348503.html</id>
    <content type="html">
<![CDATA[<p>-- ç”Ÿæˆ RSA ç§é’¥ï¼ˆå¸¦å¯†ç çš„ï¼‰<br/>
openssl genrsa -des3 -out rsa_private_key.pem 2048</p>

<p>-- ç”Ÿæˆ RSA ç§é’¥ï¼ˆä¼ ç»Ÿæ ¼å¼çš„ï¼‰</p>

<p>openssl genrsa -out rsa_private_key.pem 2048</p>

<p>-- å°†ä¼ ç»Ÿæ ¼å¼çš„ç§é’¥è½¬æ¢æˆ PKCS#8 æ ¼å¼çš„</p>

<p>openssl pkcs8 -topk8 -inform PEM -in rsa_private_key.pem -outform PEM -nocrypt</p>

<p>-- ç”Ÿæˆ RSA å…¬é’¥</p>

<p>openssl rsa -in rsa_private_key.pem -pubout -out rsa_public_key.pem</p>

<p>-- è¯ä¹¦è¯·æ±‚ï¼ˆå¯æ‹¿åˆ°ç¬¬ä¸‰æ–¹è¿›è¡Œç­¾åï¼‰<br/>
openssl req â€“new -x509 -key rsa_private_key.pem -out server.pem</p>

<p>-- è‡ªç­¾åè¯ä¹¦<br/>
openssl req -new -x509 -key rsa_private_key.pem -out ca.pem -days 1095</p>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æ•°æ®å­—å…¸å¯¼å‡ºå¤‡å¿˜]]></title>
    <link href="1024coder.com/14845521346247.html"/>
    <updated>2017-01-16T15:35:34+08:00</updated>
    <id>1024coder.com/14845521346247.html</id>
    <content type="html">
<![CDATA[<p>é‡åˆ°éœ€è¦å¯¼å‡ºæ•°æ®å­—å…¸çš„æƒ…å†µï¼ŒPowerDesignçš„å¯¼å‡ºæ–¹å¼ä¸å†ç»†è¡¨ã€‚å…¶å®åœ¨æœ‰å¤‡æ³¨çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥ä»æ•°æ®åº“ä¸­å¯¼å‡ºç›¸åº”çš„å­—å…¸ã€‚</p>

<pre><code class="language-sql">SELECT  A.TABLE_NAME AS &quot;è¡¨å&quot;, A.COLUMN_NAME AS &quot;å­—æ®µå&quot;, 
DECODE(A.CHAR_LENGTH, 0, DECODE(A.DATA_SCALE, NULL, A.DATA_TYPE, A.DATA_TYPE||&#39;(&#39;||A.DATA_PRECISION||&#39;,&#39;||A.DATA_SCALE||&#39;)&#39;),
A.DATA_TYPE||&#39;(&#39;||A.CHAR_LENGTH||&#39;)&#39;) as &quot;å­—æ®µç±»å‹&quot;,A.DATA_DEFAULT AS &quot;é»˜è®¤å€¼&quot;,
A.NULLABLE AS &quot;èƒ½å¦ä¸ºç©º&quot;, B.comments AS &quot;å¤‡æ³¨&quot;
FROM sys.user_tab_columns A, sys.user_col_comments B
WHERE A.table_name=B.table_name AND A.COLUMN_NAME=B.COLUMN_NAME AND A.TABLE_NAME IN (select table_name from user_tables)
ORDER BY A.TABLE_NAME
</code></pre>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[gRPCå®æˆ˜]]></title>
    <link href="1024coder.com/14845522344116.html"/>
    <updated>2017-01-16T15:37:14+08:00</updated>
    <id>1024coder.com/14845522344116.html</id>
    <content type="html">
<![CDATA[<h4 id="toc_0"><a href="http://www.grpc.io" title="gRPC">gRPC</a>æ˜¯Googleå‡ºå“çš„ä¸€æ¬¾åŸºäº<a href="https://developers.google.com/protocol-buffers/" title="Protobuf">Protobuf</a>ä¸HTTP/2çš„é«˜æ€§èƒ½å¼€æºRPCé€šä¿¡æ¡†æ¶ã€‚</h4>

<span id="more"></span><!-- more -->

<h3 id="toc_1">1ã€åŸºç¡€é…ç½®</h3>

<p>ä¸‹è½½protobuf IDLè§£ææ‰€éœ€çš„ protoc ä¸ protoc-gen-go äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶é…ç½®</p>

<p>å·æ‡’ï¼Œç›´æ¥ä¸‹è½½å¯¹åº”å¹³å°ä¸‹çš„protocï¼š<a href="https://github.com/google/protobuf/releases">https://github.com/google/protobuf/releases</a><br/>
protoc-gen-go:<code>go get -u github.com/golang/protobuf/protoc-gen-go</code><br/>
ç„¶åå°±å¯é€šè¿‡protocæŒ‡ä»¤æ„‰å¿«çš„ç”Ÿæˆå¯¹åº”çš„æ–‡ä»¶äº†.</p>

<h3 id="toc_2">2ã€æ’°å†™IDL</h3>

<p>æ–°å»ºæ–‡ä»¶<code>hello.proto</code>å†…å®¹å¦‚ä¸‹ï¼š</p>

<pre><code>syntax = &quot;proto3&quot;;//ä½¿ç”¨çš„protobufç‰ˆæœ¬ï¼Œé»˜è®¤ä¸º2ï¼Œä½†æ˜¯æˆ‘ä»¬è¦ç”¨æœ€æ–°çš„3ï¼Œæ‰€ä»¥è¦åœ¨é¦–è¡Œéæ³¨é‡Šéƒ¨åˆ†å£°æ˜
package hello;//å¯¹åº”ç”Ÿæˆgoæ–‡ä»¶çš„åŒ…å

// The greeting service definition.
service Greeter {
  // Sends a greeting
  rpc SayHello (HelloRequest) returns (HelloReply) {}
}

// The request message containing the user&#39;s name.
message HelloRequest {
  string name = 1;
  int64 age = 2;
}

// The response message containing the greetings
message HelloReply {
  string message = 1;
  int64 age = 2;
}
</code></pre>

<p>ç„¶åæ‰§è¡Œ</p>

<pre><code>protoc ./*.proto --go_out=plugins=grpc:.
</code></pre>

<p>æ¥ç”Ÿæˆ*.pb.goæ–‡ä»¶ä¾›æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯è°ƒç”¨ã€‚ï¼ˆPSï¼šè¦cdåˆ°æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼‰</p>

<h3 id="toc_3">3ã€æœåŠ¡ç«¯</h3>

<pre><code class="language-go">// server is used to implement hello.GreeterServer.
type server struct{}

// SayHello implements hello.GreeterServer
func (s *server) SayHello(ctx context.Context, in *hello.HelloRequest) (*hello.HelloReply, error) {
    fmt.Println(&quot;request comming...&quot;)
    return &amp;hello.HelloReply{Message: &quot;Hello &quot; + in.Name, Age:28}, nil
}

func main() {
    lis, err := net.Listen(&quot;tcp&quot;, &quot;:50051&quot;)
    if err != nil {
        log.Fatalf(&quot;failed to listen: %v&quot;, err)
    }

    s := grpc.NewServer()
    hello.RegisterGreeterServer(s, &amp;server{})
    s.Serve(lis)
}
</code></pre>

<h3 id="toc_4">4ã€å®¢æˆ·ç«¯</h3>

<pre><code class="language-go">const (
    address = &quot;localhost:50051&quot;
    defaultName = &quot;world&quot;
)

func main() {
    conn, err := grpc.Dial(address, grpc.WithInsecure())
    if err != nil {
        log.Fatalf(&quot;did not connect: %v&quot;, err)
    }
    defer conn.Close()

    c := hello.NewGreeterClient(conn)

    r, err := c.SayHello(context.Background(), &amp;hello.HelloRequest{Name: defaultName, Age:32})

    if err != nil {
        log.Fatalf(&quot;could not greet: %v&quot;, err)
    }
    
    fmt.Printf(&quot;Greeting: %s&quot;, r.String())
}

</code></pre>

<h3 id="toc_5">5ã€Contextä¼ å€¼</h3>

<p>å¯ä»¥ä½¿ç”¨metadataåœ¨contextä¸­åœ¨æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä¹‹é—´è¿›è¡Œä¸Šä¸‹æ–‡äº¤äº’ã€‚</p>

<p>å¯¹äºå®¢æˆ·ç«¯å‘é€å€¼ï¼š</p>

<pre><code>ctx := metadata.NewContext(
            context.Background(),
            metadata.Pairs(&quot;key1&quot;, &quot;val1&quot;, &quot;key2&quot;, &quot;val2&quot;),
        )
</code></pre>

<p>å¯¹äºæœåŠ¡ç«¯å–å€¼ï¼š</p>

<pre><code>md, _ := metadata.FromContext(ctx)
fmt.Println(md[&quot;key1&quot;])
</code></pre>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[go reflect åå°„æ¢ç©¶]]></title>
    <link href="1024coder.com/14845521808276.html"/>
    <updated>2017-01-16T15:36:20+08:00</updated>
    <id>1024coder.com/14845521808276.html</id>
    <content type="html">
<![CDATA[<blockquote>
<p>åå°„åœ¨è®¡ç®—æœºçš„æ¦‚å¿µé‡Œæ˜¯æŒ‡ä¸€æ®µç¨‹åºå®¡æŸ¥è‡ªèº«ç»“æ„çš„èƒ½åŠ›ï¼Œä¸»è¦é€šè¿‡ç±»å‹è¿›è¡Œå®¡æŸ¥ã€‚å®ƒæ˜¯å…ƒç¼–ç¨‹çš„ä¸€ç§å½¢å¼ï¼ŒåŒæ ·ä¹Ÿæ˜¯å¼•èµ·æ··ä¹±çš„é‡å¤§æ¥æºã€‚</p>
</blockquote>

<p>ä½†åŒæ—¶ï¼Œåˆç†åˆ©ç”¨åå°„ä¹Ÿä¸ºæˆ‘ä»¬ç¼–ç¨‹æä¾›äº†éå¸¸çµæ´»çš„æ“ä½œæ–¹å¼åŠtrickï¼Œè®©ç¨‹åºæ›´å¥½çš„è¿è¡Œã€‚</p>

<span id="more"></span><!-- more -->

<h3 id="toc_0">go reflect ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š</h3>

<h3 id="toc_1">go reflect ä¸»è¦åº”ç”¨åœºæ™¯ï¼š</h3>

<pre><code>éå†ç»“æ„ä½“å­—æ®µå
ä¿®æ”¹ç»“æ„ä½“ä¸­å­—æ®µæ•°å€¼
è°ƒç”¨ç»“æ„ä½“æ–¹æ³•
è·å–ç»“æ„ä½“çš„tagæ ‡è®°
</code></pre>

<p>å¾…ç¼–è¾‘ã€‚ã€‚ã€‚</p>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MySQLä¸»ä»é…ç½®]]></title>
    <link href="1024coder.com/14845523386570.html"/>
    <updated>2017-01-16T15:38:58+08:00</updated>
    <id>1024coder.com/14845523386570.html</id>
    <content type="html">
<![CDATA[<p>è®°å½•ä¸‹mysqlçš„ä¸»ä»é…ç½®æ–¹æ¡ˆã€‚</p>

<span id="more"></span><!-- more -->

<h4 id="toc_0">ä¸»åº“my.inié…ç½®</h4>

<pre><code>server-id=1 #ç»™æ•°æ®åº“æœåŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸€èˆ¬è®¾ç½®ä¸ºæœåŠ¡å™¨ipçš„æœ«å°¾å·
log_bin = /var/log/mysql/mariadb-bin
log_bin_index = /var/log/mysql/mariadb-bin.index
binlog-do-db = cl #åŒæ­¥clåº“ å…¶ä»–åº“éƒ½ä¸åŒæ­¥
#binlog-ignore-db = mysql,information_schema //ä¸åŒæ­¥
</code></pre>

<h4 id="toc_1">ä»åº“my.inié…ç½®</h4>

<pre><code>server-id = 2 #å¤šä¸ªä»æœåŠ¡å™¨idä¸èƒ½é‡å¤
log-bin = /var/log/mysql/mariadb-bin #è§†éœ€æ±‚å¯é€‰æ‹©å…³é—­è¯¥binlog
relay-log = /var/log/mysql/relay-log
relay-log-index = /var/log/mysql/relay-log-index
replicate-do-db = cl #åŒæ­¥clåº“ å…¶ä»–åº“éƒ½ä¸åŒæ­¥
</code></pre>

<h4 id="toc_2">ç»™ä¸»åº“é…ç½®ç”¨äºåŒæ­¥çš„æˆæƒè´¦å·</h4>

<pre><code>master:mysql&gt;grant replication slave on *.* to &#39;username&#39;@&#39;%&#39; identified by &#39;password&#39;;
master:mysql&gt;flush privileges;
</code></pre>

<h4 id="toc_3">å¦‚æœæœåŠ¡å™¨å·²ç»è¿è¡Œäº†å¤§é‡æ—¶é—´ä¸”æ—¥å¿—è‡ªåŠ¨æ¸…é™¤è¿‡ï¼Œè¦å…ˆå°†è¿‡å¾€æ•°æ®å¯¼å‡ºå¹¶å¯¹ä»åº“åšæ•°æ®æ¢å¤ã€‚</h4>

<pre><code>master:mysql&gt;flush tables with read lock; #é”æ‰masteræœåŠ¡å™¨çš„æ‰€æœ‰è¡¨ï¼Œç¦æ­¢å†™å…¥ã€‚
master:mysql&gt;show master status; #æŸ¥çœ‹å¹¶è®°å½•ä¸‹ File mariadb-bin.000019, Position 84567
mysqldump -u root -p dbName &gt; db.sql
master:mysql&gt; unlock tables; #å¯¼å‡ºå®Œæˆä¹‹åï¼Œè§£é”ã€‚ masterå¯ä»¥ç»§ç»­è·‘èµ·æ¥äº†ã€‚
</code></pre>

<p>å°†äº§ç”Ÿçš„db.sqlæ‹·è´è‡³ä»æœåŠ¡å™¨ï¼Œåšæ¢å¤ã€‚</p>

<p><code>mysql -u root -p dbName &lt; db.sql</code> æˆ– <code>slave:mysql&gt;source db.sql</code></p>

<h4 id="toc_4">é…ç½®ä»æœåŠ¡å™¨</h4>

<pre><code>slave:mysql&gt;change master to master_host=&#39;104.236.166.xxx&#39;,master_user=&#39;username&#39;,master_password=&#39;password&#39;,master_port=3306,master_log_file=&#39;mariadb-bin.000019&#39;,master_log_pos=84567;
</code></pre>

<h4 id="toc_5">é…ç½®æ£€æŸ¥</h4>

<pre><code>slave:mysql&gt;show slave status\G
å¦‚æœä»¥ä¸‹éƒ½ä¸ºYesçš„è¯ï¼Œè¯´æ˜é…ç½®æˆåŠŸä¸”è¿è¡Œæ­£å¸¸
Slave_IO_Running: Yes
Slave_SQL_Running: Yes

slave:mysql&gt;show processlist; #æ˜¾ç¤ºä»æœåŠ¡å™¨ä¸Šçš„è¿›ç¨‹
</code></pre>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linuxä¸­å¸¸ç”¨æ“ä½œå‘½ä»¤]]></title>
    <link href="1024coder.com/14845548132443.html"/>
    <updated>2017-01-16T16:20:13+08:00</updated>
    <id>1024coder.com/14845548132443.html</id>
    <content type="html">
<![CDATA[<p>è®°å½•ä¸‹Linuxçš„å¸¸ç”¨å‘½ä»¤ï¼Œä»¥å¤‡ä¸æ—¶ä¹‹éœ€ã€‚</p>

<span id="more"></span><!-- more -->

<p>å¸¸è§æŒ‡ä»¤:</p>

<pre><code class="language-bash">lsã€€ã€€        æ˜¾ç¤ºæ–‡ä»¶æˆ–ç›®å½•
     -l          åˆ—å‡ºæ–‡ä»¶è¯¦ç»†ä¿¡æ¯l(list)
     -a          åˆ—å‡ºå½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶åŠç›®å½•ï¼ŒåŒ…æ‹¬éšè—çš„a(all)
mkdir        åˆ›å»ºç›®å½•
     -p          åˆ›å»ºç›®å½•ï¼Œè‹¥æ— çˆ¶ç›®å½•ï¼Œåˆ™åˆ›å»ºp(parent)
cd           åˆ‡æ¢ç›®å½•
touch        åˆ›å»ºç©ºæ–‡ä»¶
echo         åˆ›å»ºå¸¦æœ‰å†…å®¹çš„æ–‡ä»¶ã€‚
cat          æŸ¥çœ‹æ–‡ä»¶å†…å®¹
cp           æ‹·è´
mv           ç§»åŠ¨æˆ–é‡å‘½å
rm           åˆ é™¤æ–‡ä»¶
     -r          é€’å½’åˆ é™¤ï¼Œå¯åˆ é™¤å­ç›®å½•åŠæ–‡ä»¶
     -f          å¼ºåˆ¶åˆ é™¤
find         åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æœç´¢æŸæ–‡ä»¶
wc           ç»Ÿè®¡æ–‡æœ¬ä¸­è¡Œæ•°ã€å­—æ•°ã€å­—ç¬¦æ•°
grep         åœ¨æ–‡æœ¬æ–‡ä»¶ä¸­æŸ¥æ‰¾æŸä¸ªå­—ç¬¦ä¸²
rmdir        åˆ é™¤ç©ºç›®å½•
tree         æ ‘å½¢ç»“æ„æ˜¾ç¤ºç›®å½•ï¼Œéœ€è¦å®‰è£…treeåŒ…
pwd          æ˜¾ç¤ºå½“å‰ç›®å½•
ln           åˆ›å»ºé“¾æ¥æ–‡ä»¶
moreã€less   åˆ†é¡µæ˜¾ç¤ºæ–‡æœ¬æ–‡ä»¶å†…å®¹
headã€tail   æ˜¾ç¤ºæ–‡ä»¶å¤´ã€å°¾å†…å®¹
ctrl+alt+F1  å‘½ä»¤è¡Œå…¨å±æ¨¡å¼
</code></pre>

<p>ç³»ç»Ÿç®¡ç†å‘½ä»¤:</p>

<pre><code class="language-bash">stat         æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”lsæ›´è¯¦ç»†
who          æ˜¾ç¤ºåœ¨çº¿ç™»é™†ç”¨æˆ·
whoami       æ˜¾ç¤ºå½“å‰æ“ä½œç”¨æˆ·
hostname     æ˜¾ç¤ºä¸»æœºå
uname        æ˜¾ç¤ºç³»ç»Ÿç®€è¦ä¿¡æ¯
     -a          æ˜¾ç¤ºç³»ç»Ÿå®Œæ•´ä¿¡æ¯
top          åŠ¨æ€æ˜¾ç¤ºå½“å‰è€—è´¹èµ„æºæœ€å¤šè¿›ç¨‹ä¿¡æ¯
ps           æ˜¾ç¤ºç¬é—´è¿›ç¨‹çŠ¶æ€ ps aux
     -ef         æ˜¾ç¤ºç³»ç»Ÿå¸¸é©»è¿›ç¨‹
du           æŸ¥çœ‹ç›®å½•å¤§å° du -h /homeå¸¦æœ‰å•ä½æ˜¾ç¤ºç›®å½•ä¿¡æ¯
df           æŸ¥çœ‹ç£ç›˜å¤§å° df -h å¸¦æœ‰å•ä½æ˜¾ç¤ºç£ç›˜ä¿¡æ¯
ifconfig     æŸ¥çœ‹ç½‘ç»œæƒ…å†µ
ping         æµ‹è¯•ç½‘ç»œè¿é€š
netstat      æ˜¾ç¤ºç½‘ç»œçŠ¶æ€ä¿¡æ¯
man          æ˜¾ç¤ºå‘½ä»¤æ‰‹å†Œ
clear        æ¸…å±
alias        å¯¹å‘½ä»¤é‡å‘½å å¦‚ï¼šalias showmeit=â€ps auxâ€ ï¼Œå¦å¤–è§£é™¤ä½¿ç”¨unaliax showmeit
kill         æ€æ­»è¿›ç¨‹ï¼Œå¯ä»¥å…ˆç”¨ ps æˆ– top å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹çš„idï¼Œç„¶åå†ç”¨killå‘½ä»¤æ€æ­»è¿›ç¨‹ã€‚
</code></pre>

<p>æ‰“åŒ…å‹ç¼©ç›¸å…³å‘½ä»¤:</p>

<pre><code class="language-bash">gzipï¼š
bzip2ï¼š
tar:            æ‰“åŒ…å‹ç¼©
     -c             å½’æ¡£æ–‡ä»¶
     -x             è§£å‹ç¼©æ–‡ä»¶
     -z             gzipå‹ç¼©æ–‡ä»¶
     -j             bzip2å‹ç¼©æ–‡ä»¶
     -v             æ˜¾ç¤ºå‹ç¼©æˆ–è§£å‹ç¼©è¿‡ç¨‹ v(view)
     -f             ä½¿ç”¨æ¡£å
ä¾‹ï¼š
tar -cvf /home/abc.tar /home/abc            åªæ‰“åŒ…ï¼Œä¸å‹ç¼©
tar -zcvf /home/abc.tar.gz /home/abc        æ‰“åŒ…ï¼Œå¹¶ç”¨gzipå‹ç¼©
tar -jcvf /home/abc.tar.bz2 /home/abc       æ‰“åŒ…ï¼Œå¹¶ç”¨bzip2å‹ç¼©

å¦‚æœæƒ³è§£å‹ç¼©ï¼Œå°±ç›´æ¥æ›¿æ¢ä¸Šé¢çš„å‘½ä»¤  tar -cvf  / tar -zcvf  / tar -jcvf ä¸­çš„â€œcâ€ æ¢æˆâ€œxâ€ å°±å¯ä»¥äº†ã€‚
</code></pre>

<p>å…³æœº/é‡å¯æœºå™¨:</p>

<pre><code class="language-bash">shutdown
     -r           å…³æœºé‡å¯
     -h           å…³æœºä¸é‡å¯
     now          ç«‹åˆ»å…³æœº
halt             å…³æœº
reboot           é‡å¯
</code></pre>

<p>Linuxç®¡é“:</p>

<p>å°†ä¸€ä¸ªå‘½ä»¤çš„æ ‡å‡†è¾“å‡ºä½œä¸ºå¦ä¸€ä¸ªå‘½ä»¤çš„æ ‡å‡†è¾“å…¥ã€‚ä¹Ÿå°±æ˜¯æŠŠå‡ ä¸ªå‘½ä»¤ç»„åˆèµ·æ¥ä½¿ç”¨ï¼Œåä¸€ä¸ªå‘½ä»¤å¤„ç†å‰ä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºç»“æœã€‚</p>

<p>ä¾‹ï¼š<code>grep -r â€œcloseâ€ /home/* | more</code></p>

<p>åœ¨homeç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ä¸­æŸ¥æ‰¾ï¼ŒåŒ…æ‹¬closeçš„æ–‡ä»¶ï¼Œå¹¶åˆ†é¡µè¾“å‡ºã€‚</p>

<p>Linuxè½¯ä»¶åŒ…ç®¡ç†(centos:yum;ubuntu:apt-get):</p>

<p>ä»¥ubnuntuä¸‹å®‰è£…treeä¸ºä¾‹:</p>

<pre><code class="language-bash">sudo apt-get install tree  å®‰è£…tree
sudo apt-get remove tree  å¸è½½tree
sudo apt-get update  æ›´æ–°è½¯ä»¶
sudo apt-get upgrade
</code></pre>

<p>vimä½¿ç”¨:<br/>
vimä¸‰ç§æ¨¡å¼ï¼šå‘½ä»¤æ¨¡å¼ã€æ’å…¥æ¨¡å¼ã€ç¼–è¾‘æ¨¡å¼ã€‚ä½¿ç”¨ESCæˆ–iæˆ–ï¼šæ¥åˆ‡æ¢æ¨¡å¼ã€‚<br/>
å‘½ä»¤æ¨¡å¼ä¸‹ï¼š</p>

<pre><code class="language-bash">:q                      é€€å‡º
:q!                     å¼ºåˆ¶é€€å‡º
:wq                   ä¿å­˜å¹¶é€€å‡º
:set number      æ˜¾ç¤ºè¡Œå·
:set nonumber  éšè—è¡Œå·
/apache            åœ¨æ–‡æ¡£ä¸­æŸ¥æ‰¾å­—ç¬¦apacheï¼ŒæŒ‰nè·³åˆ°ä¸‹ä¸€ä¸ªï¼Œshift+nä¸Šä¸€ä¸ª
yyp                  å¤åˆ¶å…‰æ ‡æ‰€åœ¨è¡Œï¼Œå¹¶ç²˜è´´
h(å·¦ç§»ä¸€ä¸ªå­—ç¬¦â†)ã€j(ä¸‹ä¸€è¡Œâ†“)ã€k(ä¸Šä¸€è¡Œâ†‘)ã€l(å³ç§»ä¸€ä¸ªå­—ç¬¦â†’)
</code></pre>

<p>ç”¨æˆ·åŠç”¨æˆ·ç»„ç®¡ç†</p>

<pre><code class="language-bash">/etc/passwd      å­˜å‚¨ç”¨æˆ·è´¦å·
/etc/group       å­˜å‚¨ç»„è´¦å·
/etc/shadow      å­˜å‚¨ç”¨æˆ·è´¦å·çš„å¯†ç 
/etc/gshadow     å­˜å‚¨ç”¨æˆ·ç»„è´¦å·çš„å¯†ç 
useradd user     æ·»åŠ ç”¨æˆ·
userdel user     åˆ é™¤ç”¨æˆ·
groupadd user    æ·»åŠ ç»„ç”¨æˆ·
groupdel user    åˆ é™¤ç»„ç”¨æˆ·
passwd root      ç»™ç”¨æˆ·rootè®¾ç½®å¯†ç 
su root          ä¸´æ—¶ææƒåˆ°rootç”¨æˆ·
su â€“ root        åˆ‡æ¢åˆ°rootç”¨æˆ·
/etc/profile     ç³»ç»Ÿç¯å¢ƒå˜é‡
bash_profile     ç”¨æˆ·ç¯å¢ƒå˜é‡
.bashrc          ç”¨æˆ·ç¯å¢ƒå˜é‡
su user          åˆ‡æ¢ç”¨æˆ·ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶.bashrc
su â€“ user        åˆ‡æ¢ç”¨æˆ·ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶/etc/profile ï¼ŒåŠ è½½bash_profile
</code></pre>

<p>æ›´æ”¹æ–‡ä»¶çš„ç”¨æˆ·åŠç”¨æˆ·ç»„</p>

<pre><code class="language-bash">sudo chown [-Ré€’å½’] owner[:group] {File|Directory}
è¦æƒ³åˆ‡æ¢æ–‡ä»¶æ‰€å±çš„ç”¨æˆ·åŠç»„ã€‚å¯ä»¥ä½¿ç”¨å‘½ä»¤ã€‚
sudo chown root:root rarlinux-x64-5.1.b3.tar.gz
</code></pre>

<p>æ–‡ä»¶æƒé™ç®¡ç†</p>

<p>ä¸‰ç§åŸºæœ¬æƒé™</p>

<pre><code class="language-bash">R    è¯»        æ•°å€¼è¡¨ç¤ºä¸º4
W    å†™        æ•°å€¼è¡¨ç¤ºä¸º2
X    å¯æ‰§è¡Œ     æ•°å€¼è¡¨ç¤ºä¸º1
</code></pre>

<p>æ›´æ”¹æƒé™<br/>
sudo chmod [uæ‰€å±ç”¨æˆ·  gæ‰€å±ç»„  oå…¶ä»–ç”¨æˆ·  aæ‰€æœ‰ç”¨æˆ·]  [+å¢åŠ æƒé™  -å‡å°‘æƒé™]  [r  w  x]   ç›®å½•å <br/>
ä¾‹å¦‚ï¼šæœ‰ä¸€ä¸ªæ–‡ä»¶filenameï¼Œæƒé™ä¸ºâ€œ-rw-râ€”-xâ€ ,å°†æƒé™å€¼æ”¹ä¸ºâ€-rwxrw-r-xâ€ï¼Œç”¨æ•°å€¼è¡¨ç¤ºä¸º765<br/>
<code>sudo chmod u+x g+w o+r  filename</code></p>

<p>ä¸Šé¢çš„ä¾‹å­å¯ä»¥ç”¨æ•°å€¼è¡¨ç¤º<code>sudo chmod 765 filename</code></p>

<p>ç½‘ç»œç›¸å…³</p>

<pre><code>netstat -tunlp æ˜¾ç¤ºæ‰€æœ‰ç«¯å£åŠå¯¹åº”çš„åº”ç”¨ç¨‹åº
netstat -anp æ˜¾ç¤ºç³»ç»Ÿç«¯å£ä½¿ç”¨æƒ…å†µ
lsof -i:ç«¯å£å· æŸ¥çœ‹æŸä¸€ç«¯å£çš„å ç”¨æƒ…å†µ
</code></pre>
]]>
    </content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JSONPæœ­è®°]]></title>
    <link href="1024coder.com/14845524801245.html"/>
    <updated>2017-01-16T15:41:20+08:00</updated>
    <id>1024coder.com/14845524801245.html</id>
    <content type="html">
<![CDATA[<p>webå¼€å‘ä¸­æ•°æ®çš„è·¨åŸŸä¼ é€ä¸€ç›´è®©äººè‹¦æ¼ï¼ŒJSONPçš„å‡ºç°ï¼Œä¸ºwebè·¨åŸŸä¼ è¾“æä¾›äº†ä¸€æŠŠåˆ©å™¨!</p>

<span id="more"></span><!-- more -->

<p>è¿™æ˜¯å•¥ï¼Ÿæœ‰å•¥ç”¨ï¼Ÿ</p>

<blockquote>
<p>JSONP(JSON with Padding)æ˜¯JSONçš„ä¸€ç§â€œä½¿ç”¨æ¨¡å¼â€ï¼Œå¯ç”¨äºè§£å†³ä¸»æµæµè§ˆå™¨çš„è·¨åŸŸæ•°æ®è®¿é—®çš„é—®é¢˜ã€‚</p>
</blockquote>

<p>æ€ä¹ˆç”¨ï¼Ÿ</p>

<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Top Customers with Callback&lt;/title&gt;
    &lt;script type=&quot;text/javascript&quot; src=&quot;http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id=&quot;customerList&quot;&gt;
&lt;/div&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
    function onCustomerLoaded(result) {
        var html = &#39;&lt;ul&gt;&#39;;
        for (var i = 0; i &lt; result.length; i++) {
            html += &#39;&lt;li&gt;&#39; + result[i] + &#39;&lt;/li&gt;&#39;;
        }
        html += &#39;&lt;/ul&gt;&#39;;
        document.getElementById(&#39;customerList&#39;).innerHTML = html;
    }
&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;http://127.0.0.1:8081/jsonp&quot;&gt;&lt;/script&gt;

&lt;script type=&quot;text/javascript&quot; src=&quot;http://127.0.0.1:8081/jsonp?callback=onCustomerLoaded&quot;&gt;&lt;/script&gt;

&lt;script type=&quot;text/javascript&quot;&gt;
    $.ajax({
        &#39;url&#39;: &#39;http://127.0.0.1:8081/jsonp&#39;,
        &#39;type&#39;: &#39;POST&#39;,
        &#39;dataType&#39;: &#39;JSONP&#39;,
        &#39;jsonp&#39;: &#39;callback&#39;,
        &#39;error&#39;: function (e) {
            alert(e.repsonseText);
        },
        &#39;success&#39;: function (data) {
            alert(data);
        }
    });
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>æœåŠ¡ç«¯åªéœ€è¦è¿”å›callbackå¯¹åº”funcåç§°çš„å­—ç¬¦ä¸²åŠæ•°æ®æ‹¼æ¥å³å¯ã€‚ç”¨ç†Ÿæ‚‰çš„goè¯­è¨€ç»“åˆbeegoæ¥å®ç°è¿™éƒ¨åˆ†ï¼š</p>

<pre><code class="language-go">func (this *JSONP) Get() {
    this.TplNames = &quot;jsonp.html&quot;
    this.Data[&quot;jsonp&quot;] = []int{1,2,3}
    this.ServeJsonp()
}
</code></pre>

<p><code>jsonp.html</code>ä»£ç ä¸­å†…å®¹å¦‚ä¸‹ï¼š</p>

<pre><code class="language-javascript">alert(&quot;queryä¸­æ²¡æœ‰callback!&quot;)
</code></pre>

<p>åˆ°åº•å¯ä¸å¯ä»¥POSTï¼šå¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä»£ç ä¸­ï¼Œjquery ajaxçš„éƒ¨åˆ†ä½¿ç”¨äº†POSTæ–¹æ³•ï¼Œé‚£æ˜¯ä¸æ˜¯è¯´å¯ä»¥å°†æ•°æ®æ”¾åˆ°requsetçš„bodyä¸­å‘é€è‡³æœåŠ¡å™¨ï¼Ÿ<br/>
ç­”æ¡ˆï¼šå¦‚æœè¢«è¯·æ±‚çš„urlä¸é¡µé¢åŒæºï¼Œåˆ™ç”¨POSTæ–¹æ³•ï¼ˆåŒæºæœ¬æ¥å°±å¯ä»¥POSTæ–¹æ³•è°ƒç”¨ï¼Œå¹²å˜›è´¹è¿™ä¸ªåŠ²æè¿™ä¸ªï¼‰ã€‚ã€‚ã€‚<br/>
éåŒæºçš„æ—¶å€™ï¼Œè¿™éƒ¨åˆ†ä¼šè½¬æ¢ä¸ºGETæ–¹æ³•æ‰§è¡Œã€‚</p>

<p>JSONPçš„å±€é™æ€§ï¼šæ•°æ®è¦æ”¾åˆ°urlä¸­æ¥ä¼ è¾“ï¼Œç›¸æ¯”äºä¼ ç»Ÿçš„POSTå°‘äº†äº›è®¸çµæ´»æ€§ã€‚</p>

<p>JSONPçš„å¥½å¤„ï¼šæ–¹ä¾¿è°ƒç”¨ã€‚</p>
]]>
    </content>
  </entry>
  
</feed>
